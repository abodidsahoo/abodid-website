---
export const prerender = false;
import BaseLayout from "../layouts/BaseLayout.astro";
import { getFilms } from "../lib/api";
import FilmsFilter from "../components/FilmsFilter.jsx";

const pageTitle = "Films";
const films = await getFilms();
---

<BaseLayout title={pageTitle}>
  <!-- Plyr CSS -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <div class="films-container">
    <header class="page-header">
      <h1>Films</h1>
      <p class="section-intro">
        A curation of visual stories, brand films, and experimental
        cinematography.
      </p>
    </header>

    <FilmsFilter items={films} client:load />
  </div>

  <div id="video-modal" class="video-modal">
    <div class="video-container">
      <button class="close-btn" onclick="closeVideo()">
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      </button>
      <div class="plyr__video-embed" id="player">
        <iframe src="" allowfullscreen allowtransparency allow="autoplay"
        ></iframe>
      </div>
    </div>
  </div>

  <!-- Plyr JS -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js" is:inline></script>

  <script is:inline>
    let player = null;

    function openVideo(url, provider) {
      if (!url) return;

      const modal = document.getElementById("video-modal");
      const container = document.getElementById("player");

      // Extract ID
      let videoId = "";
      if (provider === "vimeo") {
        videoId = url.split("/").pop().split("?")[0];
      } else {
        if (url.includes("youtu.be")) videoId = url.split("/").pop();
        else videoId = new URLSearchParams(new URL(url).search).get("v");
      }

      // 1. Set source for Plyr
      let embedSrc = "";
      if (provider === "vimeo") {
        embedSrc = `https://player.vimeo.com/video/${videoId}?loop=false&byline=false&portrait=false&title=false&speed=true&transparent=0&gesture=media`;
      } else {
        embedSrc = `https://www.youtube.com/embed/${videoId}?origin=${location.origin}&iv_load_policy=3&modestbranding=1&playsinline=1&showinfo=0&rel=0&enablejsapi=1`;
      }

      // 2. Strict Tear Down
      if (player) {
        player.destroy();
        player = null;
      }

      // Explicitly clear and update iframe
      const iframe = container.querySelector("iframe");
      // Force a slight delay or just direct update? Direct update usually fine if player is gone.
      iframe.src = embedSrc;

      // 3. Initialize Plyr (fresh instance)
      player = new Plyr("#player", {
        controls: [
          "play-large",
          "play",
          "progress",
          "current-time",
          "mute",
          "volume",
          "fullscreen",
        ],
        hideControls: true,
        resetOnEnd: true,
        youtube: {
          noCookie: true,
          rel: 0,
          showinfo: 0,
          iv_load_policy: 3,
          modestbranding: 1,
        },
        vimeo: {
          byline: false,
          portrait: false,
          title: false,
          speed: true,
          transparent: false,
        },
      });

      // Show modal
      modal.classList.add("active");
      document.body.style.overflow = "hidden";

      // Auto-play when ready
      player.on("ready", () => {
        player.play();
      });
    }

    window.closeVideo = function () {
      const modal = document.getElementById("video-modal");
      modal.classList.remove("active");

      if (player) {
        player.stop();
        // Optional: Destory here too to be super safe, but usually stop is enough until next open
        player.destroy();
        player = null;
      }

      document.body.style.overflow = "";

      // Clear iframe src to stop any residual loading/audio
      const iframe = document.querySelector("#player iframe");
      if (iframe) iframe.src = "";
    };

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeVideo();
    });
  </script>
</BaseLayout>

<style>
  /* Plyr Overrides for "Clean & Elegant" Look */
  :global(.plyr) {
    --plyr-color-main: white; /* Clean white accent */
    --plyr-video-control-color: white;
    --plyr-video-control-color-hover: #e0e0e0;
    font-family: var(--font-sans, system-ui, sans-serif);
    border-radius: 8px;
    overflow: hidden;
  }

  :global(.plyr__control--overlaid) {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    color: white;
  }

  :global(.plyr__control--overlaid:hover) {
    background: white;
    color: black;
  }

  .films-container {
    max-width: 1200px;
    margin: 0 auto;
    padding-bottom: 4rem;
  }

  /* Header */
  .page-header {
    margin-bottom: 5rem;
    padding-top: 2rem;
    text-align: center;
  }

  h1 {
    font-family: var(--font-serif);
    font-size: 3.5rem;
    font-weight: 400;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
    color: var(--text-primary);
  }

  .section-intro {
    font-family: var(--font-sans);
    font-size: 1.1rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  /* Modal */
  .video-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(5px);
  }

  .video-modal.active {
    opacity: 1;
    pointer-events: auto;
  }

  .video-container {
    width: 90%;
    max-width: 1200px;
    position: relative;
    border-radius: 8px;
    box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
  }

  .close-btn {
    position: absolute;
    top: -60px;
    right: 0;
    width: 44px;
    height: 44px;
    background: white;
    border: none;
    border-radius: 50%;
    color: black;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition:
      transform 0.2s ease,
      background-color 0.2s;
    z-index: 20;
  }

  .close-btn:hover {
    transform: scale(1.1);
    background-color: #f0f0f0;
  }

  /* Responsive */
  @media (max-width: 768px) {
    h1 {
      font-size: 2.5rem;
    }

    .close-btn {
      top: -50px;
      right: 0;
    }
  }
</style>
