---
export const prerender = false; // Must be false for server-side auth check
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getVaultTags, getVaultNotes } from "../../lib/github";

// Configuration
const VAULT_PASSWORD = import.meta.env.VAULT_PASSWORD || process.env.VAULT_PASSWORD || "secret";
const COOKIE_NAME = "obsidian_vault_access";
const COOKIE_MAX_AGE = 60 * 60 * 24 * 7;
const ITEMS_PER_PAGE = 24;

// Server-Side Logic
let isUnlocked = false;
let error = "";
let allNotes = [];
let initialNotes = [];
let remainingNotes = [];
let tags = [];

// 1. Check Cookie
if (Astro.cookies.has(COOKIE_NAME)) {
    const cookieVal = Astro.cookies.get(COOKIE_NAME)?.value;
    if (cookieVal === "granted") {
        isUnlocked = true;
    }
}

// 2. Handle Login Submission
if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const password = data.get("password");

        if (password === VAULT_PASSWORD) {
            isUnlocked = true;
            Astro.cookies.set(COOKIE_NAME, "granted", {
                path: "/",
                maxAge: COOKIE_MAX_AGE,
                httpOnly: true,
                secure: import.meta.env.PROD,
                sameSite: "lax",
            });
            return Astro.redirect("/research/obsidian-vault");
        } else {
            error = "Incorrect password. The vault remains sealed.";
        }
    } catch (e) {
        console.error(e);
        error = "An unexpected error occurred.";
    }
}

// 3. Fetch Data if Unlocked
if (isUnlocked) {
    console.log("Vault Unlocked. Attempting to fetch data...");
    try {
        const [tagsData, notesData] = await Promise.all([
            getVaultTags(),
            getVaultNotes(),
        ]);
        
        console.log(`Fetch Complete. Tags: ${tagsData?.length}, Notes: ${notesData?.length}`);

        tags = tagsData || [];
        allNotes = notesData || [];
        
        // Split for Infinite Scroll
        initialNotes = allNotes.slice(0, ITEMS_PER_PAGE);
        remainingNotes = allNotes.slice(ITEMS_PER_PAGE);
    } catch (e) {
        console.error("Error fetching vault data:", e);
        if (e instanceof Error) {
            error = e.message;
        } else {
            error = "Failed to fetch vault data from GitHub. Check server logs.";
        }
    }
}

const pageTitle = "Obsidian Vault";
---

<BaseLayout title={pageTitle}>
    <!-- Load Fonts: Poppins (Weights 100-500) & Inconsolata & Space Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@300;400;500;600&family=Poppins:wght@100;200;300;400;500&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <div class="vault-container">
        {
            !isUnlocked ? (
                /* --- LOCKED STATE --- */
                <section class="locked-view">
                    <header class="vault-header">
                        <h1>Obsidian Vault</h1>
                        <p class="subtitle">
                            A digital garden of raw thoughts, research, and connections.
                        </p>
                    </header>

                    <div class="pitch-content">
                        <p>
                            This vault contains my personal collection of
                            Markdown notes, directly synced from my private
                            Obsidian library. It includes unfinished research,
                            daily logs, and deeper technical explorations that
                            I'm not ready to publish as polished articles.
                        </p>

                        <div class="workshop-pitch">
                            <h3>Interested in building your own Second Brain?</h3>
                            <p>
                                I offer personalized workshops where I take you
                                through the entire route of setting up a
                                knowledge management system that actually works
                                for you. From Obsidian setup to workflow automation.
                            </p>
                            <a href="/research/workshop-booking" class="btn-primary">
                                Book a Personal Workshop
                            </a>
                        </div>
                    </div>

                    <div class="login-form-wrapper">
                        <p class="login-label">ACCESS THE VAULT</p>
                        <form method="POST" class="login-form">
                            <input
                                type="password"
                                name="password"
                                placeholder="Enter Password..."
                                required
                                autofocus
                            />
                            <button type="submit" class="btn-unlock">Unlock</button>
                        </form>
                        {error && <p class="error-msg">{error}</p>}
                        <p class="hint-text">Ask Abodid for access if you're curious.</p>
                    </div>
                </section>
            ) : (
                /* --- UNLOCKED STATE (SPLIT VIEW) --- */
                <section class="vault-view-split">
                    <header class="vault-header-split">
                         <h1>Abodid's Vault</h1>
                         <p class="subtitle">Live sync from GitHub. {allNotes.length} notes, {tags.length} tags.</p>
                         {error && <p class="error-msg" style="text-align:center; margin-top:1rem;">{error}</p>}
                    </header>
                    
                    <div class="split-layout">
                        {/* --- LEFT: NOTES LIST (Single Column Vertical, 50% Width) --- */}
                        <div class="notes-column">
                            <div class="notes-header-small">
                                <h2>Notes</h2>
                            </div>
                            <div class="vault-list" id="notes-grid">
                                {initialNotes.length === 0 ? (
                                    <div class="empty-state">
                                        <p>No notes found. Check GitHub connection.</p>
                                    </div>
                                ) : (
                                    initialNotes.map((file) => (
                                        <a href={`/research/obsidian-vault/${file.name.replace(".md", "")}`} class="note-card">
                                            <div class="note-info">
                                                <h3>{file.name.replace(".md", "").replace(/-/g, " ")}</h3>
                                            </div>
                                        </a>
                                    ))
                                )}
                            </div>
                            
                            {/* Sentinel for Infinite Scroll */}
                            {remainingNotes.length > 0 && (
                                <div id="scroll-sentinel" class="loading-indicator">
                                    <span>Loading more notes...</span>
                                </div>
                            )}
                        </div>

                        {/* --- RIGHT: TAG CLOUD (50% Width) --- */}
                        <aside class="tags-column">
                            <div class="tags-header-small">
                                <h2>Tags</h2>
                            </div>
                            <div class="tag-cloud-wrapper">
                                {tags.map((tag) => (
                                    <a href={`/research/obsidian-vault/${tag.name.replace(".md", "")}`} class="vault-tag">
                                        {tag.name.replace(".md", "").replace(/-/g, " ")}
                                    </a>
                                ))}
                            </div>
                        </aside>
                    </div>
                </section>
            )
        }
    </div>
</BaseLayout>

{/* Client-Side Infinite Scroll Script */}
{isUnlocked && remainingNotes.length > 0 && (
    <script define:vars={{ remainingNotes, ITEMS_PER_PAGE }}>
        let currentNotes = remainingNotes;
        const grid = document.getElementById('notes-grid');
        const sentinel = document.getElementById('scroll-sentinel');

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && currentNotes.length > 0) {
                loadMore();
            }
        }, { rootMargin: '200px' });

        if (sentinel) observer.observe(sentinel);

        function loadMore() {
            const batch = currentNotes.slice(0, ITEMS_PER_PAGE);
            currentNotes = currentNotes.slice(ITEMS_PER_PAGE);

            const fragment = document.createDocumentFragment();
            batch.forEach((file) => {
                const a = document.createElement('a');
                a.href = `/research/obsidian-vault/${file.name.replace(".md", "")}`;
                a.className = 'note-card fade-in';
                
                a.innerHTML = `
                    <div class="note-info">
                        <h3>${file.name.replace(".md", "").replace(/-/g, " ")}</h3>
                    </div>
                `;
                fragment.appendChild(a);
            });
            
            grid.appendChild(fragment);

            if (currentNotes.length === 0) {
                sentinel.style.display = 'none';
                observer.disconnect();
            }
        }
    </script>
)}

<style is:global>
    /* VARIABLES */
    :root {
        --vault-bg: #0f0f10;
        --vault-text: #e0e0e0;
        --vault-border: #333;
    }

    .vault-container {
        max-width: 96vw;
        margin: 0 auto;
        padding: 1rem 2rem;
        min-height: 80vh;
    }

    /* --- LAYOUT GRID: 50/50 SPLIT --- */
    .split-layout {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Big Notes, Small Tags */
        gap: 0rem; /* Large gap between the two main columns */
        margin-top: 2rem;
        align-items: start;
        border-top: 1px solid var(--border-subtle);
        padding-top: 3rem;
    }
    
    @media (max-width: 1100px) {
        .split-layout {
            grid-template-columns: 1fr;
            gap: 3rem;
        }
        .tags-column {
            border-top: 1px solid var(--border-subtle);
            padding-top: 2rem;
            width: 100%;
            border-left: none !important;
            padding-left: 0 !important;
        }
        .notes-column {
            border-right: none !important;
            padding-right: 0 !important;
        }
    }

    /* NOTES COLUMN */
    .notes-column {
        min-width: 0;
        border-right: 1px solid var(--border-subtle);
        /* 1. NARROWER NOTES: Huge padding on the right to keep away from center */
        padding-right: 9rem; 
    }

    /* TAGS COLUMN */
    .tags-column {
        /* Default 1fr from grid */
        padding-left: 6rem;
    }
    
    .notes-header-small h2, .tags-header-small h2 {
        font-size: 1.2rem;
        text-transform: uppercase;
        color: var(--text-tertiary);
        letter-spacing: 1px;
        margin-bottom: 2rem;
    }

    /* VERTICAL LIST FOR NOTES */
    .vault-list {
        display: flex;
        flex-direction: column;
        /* 2. COMPACT SPACING: Reduced gap */
        gap: 1.2rem; 
    }

    /* SHARED HEADER */
    .vault-header, .vault-header-split {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .vault-header-split {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-subtle);
    }

    h1 {
        font-family: "Space Mono", monospace;
        letter-spacing: -2px;
        margin-bottom: 0.5rem;
    }
    
    .vault-header h1 { font-size: 3rem; }
    .vault-header-split h1 { font-size: 2.5rem; }

    .subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

    /* --- COMPONENTS --- */

    /* Locked State */
    .pitch-content, .login-form-wrapper {
        max-width: 600px;
        margin: 0 auto 3rem auto;
        text-align: center;
    }
    
    .login-form-wrapper {
        padding: 2rem;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
    }
    
    .workshop-pitch {
        margin-top: 2rem;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
    }

    /* Buttons */
    .btn-primary, .btn-unlock {
        background: var(--text-main);
        color: var(--bg-body);
        font-weight: 700;
        border-radius: 6px;
        text-decoration: none;
        padding: 0.8rem 1.5rem;
        border: none;
        cursor: pointer;
    }
    .btn-primary:hover, .btn-unlock:hover { opacity: 0.9; }
    
    .login-form input {
        padding: 0.8rem;
        border: 1px solid var(--border-subtle);
        background: var(--bg-body);
        color: var(--text-main);
        border-radius: 6px;
        flex: 1;
    }
    
    .login-form { display: flex; gap: 0.5rem; }

    /* Tags: PILL SHAPE + FLOW */
    .tag-cloud-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem; /* Relaxed gap */
    }
    
    .vault-tag {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem; /* Slightly larger pills */
        background: transparent;
        border: 1px solid var(--border-subtle);
        border-radius: 50px; 
        font-size: 0.85rem; 
        color: var(--text-secondary);
        font-family: 'Poppins', sans-serif; 
        font-weight: 300; 
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        line-height: 1;
    }
    
    .vault-tag:hover {
        border-color: var(--text-main);
        color: var(--text-main);
        background: var(--bg-surface-hover);
    }

    /* NOTE CARD */
    
    .note-card {
        display: block; 
        /* 3. COMPACT CARD: Reduced padding */
        padding: 1.2rem; 
        border-radius: 8px; 
        text-decoration: none;
        color: #e0e0e0; 
        transition: transform 0.2s, background 0.2s;
        border: 1px solid var(--border-subtle); 
        background: transparent;
        width: 100%;
        margin-bottom: 0; 
    }

    .note-card:hover {
        transform: translateX(4px); 
        background: rgba(255, 255, 255, 0.03); 
        border-color: var(--text-secondary);
    }
    
    .note-info h3 {
        font-family: 'Poppins', sans-serif;
        font-weight: 500; 
        /* 4. TYPOGRAPHY: Smaller, Darker */
        font-size: 1rem; 
        margin: 0;
        color: #8a8a8a; /* Darker/Greyer */
        text-transform: capitalize;
        line-height: 1.3;
    }

    /* Animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out forwards; }
    
    .error-msg { color: #ff6b6b; margin-top: 1rem; }
    .hint-text { margin-top: 1rem; font-size: 0.8rem; color: var(--text-tertiary); }
    
    .loading-indicator {
        margin-top: 2rem;
        text-align: center;
        color: var(--text-tertiary);
        font-family: 'Space Mono', monospace;
        grid-column: 1 / -1;
        font-size: 0.8rem;
    }
</style>
