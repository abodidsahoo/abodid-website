---
export const prerender = false;
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getFileContent, getVaultTags } from "../../../lib/github";
import { marked } from "marked";
import ShareButtons from "../../../components/ShareButtons.jsx";

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/research/obsidian-vault");
}

let htmlContent = "";
let title = slug.split("/").pop() || "Note";

try {
    const cleanSlug = slug.endsWith(".md") ? slug : `${slug}.md`;
    const filePathNotes = `6 - Main Notes/${cleanSlug}`;
    const rawContent = await getFileContent(filePathNotes);

    if (rawContent === null) {
        const fallbackTag = cleanSlug.replace(/\.md$/i, "");
        return Astro.redirect(`/research/obsidian-vault/tag/${encodeURIComponent(fallbackTag)}`);
    }

    let content = rawContent;

    const tagsData = await getVaultTags();
    const tagSet = new Set(
        (tagsData || [])
            .filter((item) => item?.type === "file")
            .map((item) => item?.name?.replace(/\.md$/i, "").toLowerCase())
            .filter(Boolean),
    );

    content = content.replace(/!\[\[(.*?)\]\]/g, (match, filename) => {
        const cleanFilename = filename.split("|")[0];
        return `![](/research/obsidian-vault/assets/${cleanFilename})`;
    });

    content = content.replace(
        /!\[(.*?)\]\((.*?)(?:7%20-%20Assets|7 - Assets)\/(.*?)\)/g,
        "![$1](/research/obsidian-vault/assets/$3)",
    );

    content = content.replace(/\[\[(.*?)\]\]/g, (match, raw) => {
        const parts = raw.split("|");
        const linkTargetRaw = (parts[0] || "").trim();
        const linkText = (parts[1] || parts[0] || "").trim();
        const linkTarget = linkTargetRaw.replace(/\.md$/i, "");
        const isTag = tagSet.has(linkTarget.toLowerCase());
        const hrefBase = isTag ? "/research/obsidian-vault/tag/" : "/research/obsidian-vault/";
        return `[${linkText}](${hrefBase}${encodeURIComponent(linkTarget)})`;
    });

    const renderer = new marked.Renderer();
    renderer.image = ({ href, title, text }) => {
        if (
            href &&
            (href.includes("7 - Assets") || href.includes("7%20-%20Assets"))
        ) {
            const parts = href.split("/");
            const filename = parts[parts.length - 1];
            return `<img src="/research/obsidian-vault/assets/${filename}" alt="${text}" title="${title || ""}" />`;
        }
        return `<img src="${href}" alt="${text}" title="${title || ""}" />`;
    };

    htmlContent = await marked.parse(content, { renderer });
    title = cleanSlug.replace(/\.md$/i, "");
} catch (error) {
    console.error(error);
    htmlContent = "<p>Error loading note.</p>";
}
---

<BaseLayout title={title}>
    <div class="note-container">
        <nav class="note-nav">
            <a href="/research/obsidian-vault" class="back-pill">‚Üê Back to Vault</a>
        </nav>

        <article class="note-content">
            <h1>{title.replace(/-/g, " ")}</h1>
            <div class="markdown-body" set:html={htmlContent} />

            <ShareButtons
                client:only="react"
                title={title.replace(/-/g, " ")}
                url={Astro.url.href}
            />
        </article>
    </div>
</BaseLayout>

<style>
    .note-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .note-nav {
        margin-bottom: 2rem;
    }

    .back-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        padding: 0.52rem 0.9rem;
        border: 1px solid var(--border-subtle);
        border-radius: 999px;
        background: var(--bg-canvas);
        color: var(--text-tertiary);
        text-decoration: none;
        font-size: 0.78rem;
        font-family: var(--font-ui);
        letter-spacing: 0.05em;
        text-transform: uppercase;
        transition: color 0.2s, border-color 0.2s, background 0.2s, transform 0.2s;
    }

    .back-pill:hover {
        color: var(--text-primary);
        border-color: var(--text-secondary);
        background: var(--bg-surface);
        transform: translateY(-1px);
    }

    .note-content h1 {
        font-size: 2.5rem;
        margin-bottom: 2rem;
        text-transform: capitalize;
    }

    .markdown-body {
        font-family: var(--feature-obsidian-note-body-font, var(--font-body));
        font-size: var(--feature-obsidian-note-body-size, 1.05rem);
        font-weight: var(--feature-obsidian-note-body-weight, 400);
        line-height: var(--feature-obsidian-note-body-line-height, 1.7);
        letter-spacing: var(--feature-obsidian-note-body-letter-spacing, 0em);
        color: var(--feature-obsidian-note-body-color, var(--text-secondary));
    }

    .markdown-body :global(h1),
    .markdown-body :global(h2),
    .markdown-body :global(h3) {
        color: var(--text-main);
        margin-top: 2rem;
        margin-bottom: 1rem;
    }

    .markdown-body :global(a) {
        color: var(--text-main);
        text-decoration: underline;
        text-decoration-color: var(--border-subtle);
        text-underline-offset: 4px;
    }

    .markdown-body :global(img) {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1.5rem 0;
        display: block;
        border: 1px solid var(--border-subtle);
    }
</style>
