---
export const prerender = false;
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getFileContent } from "../../../lib/github";
import { marked } from "marked";

const { slug } = Astro.params;
const COOKIE_NAME = "obsidian_vault_access";

// 1. Auth Check
if (
    !Astro.cookies.has(COOKIE_NAME) ||
    Astro.cookies.get(COOKIE_NAME)?.value !== "granted"
) {
    return Astro.redirect("/research/obsidian-vault");
}

if (!slug) {
    return Astro.redirect("/research/obsidian-vault");
}

// 2. Fetch Content
let content = "";
let htmlContent = "";
let title = slug.split("/").pop() || "Note";

try {
    // Append .md if missing (standard for Obsidian links often, but url has no extension)
    // The link from the main page was created with .replace('.md', ''), so we add it back.
    const filePath = slug.endsWith(".md") ? slug : `${slug}.md`;
    content = await getFileContent(filePath);

    if (content) {
        // Parse Markdown
        // You might want to sanitize this if you don't trust the repo content,
        // but since it's your own vault, it's generally safe.
        htmlContent = await marked.parse(content);
    } else {
        htmlContent = "<p>Note not found or empty.</p>";
    }
} catch (e) {
    console.error(e);
    htmlContent = "<p>Error loading note.</p>";
}
---

<BaseLayout title={title}>
    <div class="note-container">
        <nav class="note-nav">
            <a href="/research/obsidian-vault">‚Üê Back to Vault</a>
        </nav>

        <article class="note-content">
            <h1>{title.replace(/-/g, " ")}</h1>
            <div class="markdown-body" set:html={htmlContent} />
        </article>
    </div>
</BaseLayout>

<style>
    .note-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .note-nav {
        margin-bottom: 2rem;
    }

    .note-nav a {
        color: var(--text-tertiary);
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.2s;
    }

    .note-nav a:hover {
        color: var(--text-main);
    }

    .note-content h1 {
        font-size: 2.5rem;
        margin-bottom: 2rem;
        text-transform: capitalize;
    }

    /* Markdown Styles */
    .markdown-body {
        line-height: 1.7;
        color: var(--text-secondary);
        font-size: 1.05rem;
    }

    .markdown-body :global(h1),
    .markdown-body :global(h2),
    .markdown-body :global(h3) {
        color: var(--text-main);
        margin-top: 2rem;
        margin-bottom: 1rem;
    }

    .markdown-body :global(a) {
        color: var(--text-main);
        text-decoration: underline;
        text-decoration-color: var(--border-subtle);
        text-underline-offset: 4px;
    }

    .markdown-body :global(code) {
        background: var(--bg-surface);
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: "Space Mono", monospace;
    }

    .markdown-body :global(pre) {
        background: var(--bg-surface);
        padding: 1.5rem;
        border-radius: 8px;
        overflow-x: auto;
        border: 1px solid var(--border-subtle);
    }

    .markdown-body :global(ul),
    .markdown-body :global(ol) {
        padding-left: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .markdown-body :global(blockquote) {
        border-left: 4px solid var(--text-tertiary);
        padding-left: 1rem;
        margin-left: 0;
        font-style: italic;
        color: var(--text-tertiary);
    }

    .markdown-body :global(img) {
        max-width: 100%;
        border-radius: 8px;
        margin: 1rem 0;
    }
</style>
