---
export const prerender = false;
import BaseLayout from "../../../layouts/BaseLayout.astro";
import { getFileContent, getFileRaw } from "../../../lib/github";
import { findNotesReferencing } from "../../../lib/vault";
import { marked } from "marked";
import ShareButtons from "../../../components/ShareButtons.jsx";

const { slug } = Astro.params;
const COOKIE_NAME = "obsidian_vault_access";

// 1. Auth Check
if (
    !Astro.cookies.has(COOKIE_NAME) ||
    Astro.cookies.get(COOKIE_NAME)?.value !== "granted"
) {
    return Astro.redirect("/research/obsidian-vault");
}

if (!slug) {
    return Astro.redirect("/research/obsidian-vault");
}

let content: string | null = "";
let htmlContent = "";
let title = slug.split("/").pop() || "Note";
let isTagView = false;
let searchResults = [];

try {
    const cleanSlug = slug.endsWith(".md") ? slug : `${slug}.md`;

    // A. Try "6 - Main Notes"
    const folderNotes = "6 - Main Notes";
    const filePathNotes = `${folderNotes}/${cleanSlug}`;
    content = await getFileContent(filePathNotes);

    if (content) {
        // --- IT IS A MAIN NOTE ---

        // 1. Convert Obsidian Image Embeds: ![[image.png]]
        content = content.replace(/!\[\[(.*?)\]\]/g, (match, filename) => {
            const cleanFilename = filename.split("|")[0];
            return `![](/research/obsidian-vault/assets/${cleanFilename})`;
        });

        // 2. Convert standard Markdown images
        content = content.replace(
            /!\[(.*?)\]\((.*?)(?:7%20-%20Assets|7 - Assets)\/(.*?)\)/g,
            "![$1](/research/obsidian-vault/assets/$3)",
        );

        // 3. Convert Obsidian Internal Links -> Local Links
        content = content.replace(/\[\[(.*?)\]\]/g, (match, p1) => {
            const parts = p1.split("|");
            const linkTarget = parts[0];
            const linkText = parts[1] || parts[0];
            return `[${linkText}](/research/obsidian-vault/${linkTarget})`;
        });

        const renderer = new marked.Renderer();
        renderer.image = ({ href, title, text }) => {
            if (
                href &&
                (href.includes("7 - Assets") || href.includes("7%20-%20Assets"))
            ) {
                const parts = href.split("/");
                const filename = parts[parts.length - 1];
                return `<img src="/research/obsidian-vault/assets/${filename}" alt="${text}" title="${title || ""}" />`;
            }
            return `<img src="${href}" alt="${text}" title="${title || ""}" />`;
        };

        htmlContent = await marked.parse(content, { renderer });
    } else {
        // --- B. CHECK IF IT IS A TAG ---
        const folderTags = "3 - Tags";
        const filePathTags = `${folderTags}/${cleanSlug}`;

        // Check for tag existence
        const tagCheck = await getFileContent(filePathTags);

        if (tagCheck !== null) {
            // IT IS A TAG!
            isTagView = true;
            title = `Tag: ${cleanSlug.replace(".md", "")}`;

            const tagName = cleanSlug.replace(".md", "");

            // USE NEW VAULT LOGIC HERE
            // Replaces: const query = `[[${tagName}]]`; const results = await searchRepo(query);
            console.log(`[Page] Finding backlinks for tag: ${tagName}`);
            searchResults = await findNotesReferencing(tagName);
        } else {
            htmlContent = "<p>Note not found.</p>";
        }
    }
} catch (e) {
    console.error(e);
    htmlContent = "<p>Error loading note.</p>";
}
---

<BaseLayout title={title}>
    <div class="note-container">
        <nav class="note-nav">
            <a href="/research/obsidian-vault">‚Üê Back to Vault</a>
        </nav>

        <article class="note-content">
            <h1>{title.replace(/-/g, " ")}</h1>

            {
                isTagView ? (
                    /* --- TAG VIEW RESULTS --- */
                    <div class="tag-results">
                        <p class="search-meta">
                            Found {searchResults.length} notes using this tag.
                        </p>

                        <div class="vault-list">
                            {searchResults.length === 0 ? (
                                <p>No notes found referencing this tag.</p>
                            ) : (
                                searchResults.map((file) => (
                                    <a
                                        href={`/research/obsidian-vault/${file.name.replace(".md", "")}`}
                                        class="note-card"
                                    >
                                        <div class="note-info">
                                            <h3>
                                                {file.name
                                                    .replace(".md", "")
                                                    .replace(/-/g, " ")}
                                            </h3>
                                        </div>
                                    </a>
                                ))
                            )}
                        </div>
                    </div>
                ) : (
                    /* --- STANDARD NOTE VIEW --- */
                    <div class="markdown-body" set:html={htmlContent} />
                )
            }
            <ShareButtons
                client:only="react"
                title={title.replace(/-/g, " ")}
                url={Astro.url.href}
            />
        </article>
    </div>
</BaseLayout>

<style>
    .note-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }

    .note-nav {
        margin-bottom: 2rem;
    }

    .note-nav a {
        color: var(--text-tertiary);
        text-decoration: none;
        font-size: 0.9rem;
        transition: color 0.2s;
    }

    .note-nav a:hover {
        color: var(--text-main);
    }

    .note-content h1 {
        font-size: 2.5rem;
        margin-bottom: 2rem;
        text-transform: capitalize;
    }

    /* Markdown Styles */
    .markdown-body {
        line-height: 1.7;
        color: var(--text-secondary);
        font-size: 1.05rem;
    }

    .markdown-body :global(h1),
    .markdown-body :global(h2),
    .markdown-body :global(h3) {
        color: var(--text-main);
        margin-top: 2rem;
        margin-bottom: 1rem;
    }

    .markdown-body :global(a) {
        color: var(--text-main);
        text-decoration: underline;
        text-decoration-color: var(--border-subtle);
        text-underline-offset: 4px;
    }

    .markdown-body :global(img) {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1.5rem 0;
        display: block;
        border: 1px solid var(--border-subtle);
    }

    /* Tag View Styles */
    .search-meta {
        color: var(--text-tertiary);
        margin-bottom: 2rem;
        font-family: "Space Mono", monospace;
        font-size: 0.9rem;
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: 1rem;
    }

    .vault-list {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
    }

    /* MATCHING MAIN VAULT CARD STYLE */
    .note-card {
        display: block;
        padding: 1.2rem;
        border-radius: 8px;
        text-decoration: none;
        color: #e0e0e0;
        transition:
            transform 0.2s,
            background 0.2s;
        border: 1px solid var(--border-subtle);
        background: transparent;
        width: 100%;
        margin-bottom: 0;
    }

    .note-card:hover {
        transform: translateX(4px);
        background: rgba(255, 255, 255, 0.03);
        border-color: var(--text-secondary);
    }

    .note-info h3 {
        font-family: "Poppins", sans-serif;
        font-weight: 500;
        font-size: 1rem;
        margin: 0;
        color: #8a8a8a; /* Darker/Greyer */
        text-transform: capitalize;
        line-height: 1.3;
    }
</style>
