---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllStories, getStoryBySlug } from '../../lib/api';
import { marked } from 'marked';

export const prerender = false;

const { slug } = Astro.params;

const storyContent = await getStoryBySlug(slug);

if (!storyContent) {
  return Astro.redirect('/404');
}

const contentHtml = marked.parse(storyContent.content || "");
---

<BaseLayout title={storyContent.title}>
  <article class="story-article">
    <header class="story-header">
      <span class="meta">{storyContent.date}</span>
      <h1>{storyContent.title}</h1>
      <p class="intro text-serif">{storyContent.intro}</p>
    </header>

    <div class="prose story-prose" set:html={contentHtml}></div>

    <div class="story-content hidden-gallery">
      {/* Fallback for legacy photos table if used */}
      {storyContent.images.map((img, index) => (
        <figure class="story-image">
          <img src={img} alt={`Story image ${index + 1}`} loading="lazy" />
        </figure>
      ))}
    </div>

    <div class="story-footer">
      <a href="/photography" class="back-link">‚Üê Back to Photography</a>
    </div>
  </article>
</BaseLayout>

<style>
  .story-article {
    max-width: 900px;
    margin: 0 auto;
    padding-top: var(--space-2xl);
  }

  .story-header {
    text-align: center;
    margin-bottom: var(--space-2xl);
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
  }

  .meta {
    font-size: 0.9rem;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    display: block;
    margin-bottom: 1rem;
  }

  h1 {
    font-size: 3rem;
    margin-bottom: 2rem;
  }

  .intro {
    font-size: 1.25rem;
    color: var(--text-secondary);
    line-height: 1.7;
  }

  .story-content {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
  }

  .story-image img {
    width: 100%;
    height: auto;
    border-radius: 4px;
    /* Optional: minimal shadow for depth */
    box-shadow: 0 4px 20px rgba(0,0,0,0.03);
  }
  
  .story-footer {
    margin-top: var(--space-2xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-subtle);
    text-align: center;
  }
  
  .back-link {
    font-weight: 500;
  }

  .story-prose {
    font-family: var(--font-serif);
    font-size: 1.125rem;
    line-height: 1.8;
    color: var(--text-primary);
    max-width: 800px;
    margin: 0 auto;
  }

  .story-prose :global(img) {
    width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 2rem 0;
  }

  .story-prose :global(p) { margin-bottom: 1.5rem; }

  .hidden-gallery { display: none; } /* Hide unless we have legacy images */
