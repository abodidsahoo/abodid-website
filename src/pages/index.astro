---
export const prerender = false;
import BaseLayout from "../layouts/BaseLayout.astro";
import PhotographyCard from "../components/PhotographyCard.astro";
import {
    getFeaturedPhotography,
    getRecentPosts,
    getMediaMentions,
    getFilms,
} from "../lib/api";

import {
    featuredPhotography as mockPhotography,
    recentPosts as mockRecent,
} from "../utils/mockData";

import Showreel from "../components/Showreel.astro";

import PhotoGrid from "../components/PhotoGrid.astro";
import NavigationCards from "../components/NavigationCards.astro";
import BrandFilmStrip from "../components/BrandFilmStrip";
import CardStacker from "../components/CardStacker.jsx";
import LiquidCursor from "../components/LiquidCursor.jsx";
import ExperienceModule from "../components/ExperienceModule.jsx";
import AudioScrollVolume from "../components/AudioScrollVolume.jsx";
import EngagementCTA from "../components/EngagementCTA.jsx";
import ForceDarkMode from "../components/ForceDarkMode.astro";
import captionData from "../data/landing-audio-captions.json";

const pageTitle = "Home";
// Helper to safely fetch data
const safeFetch = async (fn, fallback) => {
    try {
        return await fn();
    } catch (e) {
        console.error("Data fetch failed:", e);
        return fallback;
    }
};

// Fetch data from Supabase with Fallback
const featuredPhotography = await safeFetch(
    getFeaturedPhotography,
    mockPhotography,
);
const recentPosts = (await safeFetch(getRecentPosts, mockRecent)).slice(0, 3);
const mediaMentions = await safeFetch(getMediaMentions, []);
const films = await safeFetch(getFilms, []);

// Helper to find link by name match
const findLink = (name) => {
    const term = name.toLowerCase();

    // 1. Search Media Mentions (Publication or Title)
    const mediaMatch = mediaMentions.find(
        (m) =>
            (m.publication && m.publication.toLowerCase().includes(term)) ||
            (m.title && m.title.toLowerCase().includes(term)),
    );
    if (mediaMatch) return mediaMatch.url;

    // 2. Search Films (Title or Description)
    const filmMatch = films.find(
        (f) =>
            (f.title && f.title.toLowerCase().includes(term)) ||
            (f.description && f.description.toLowerCase().includes(term)),
    );
    if (filmMatch) return filmMatch.videoUrl || "/films"; // Fallback to /films if videoUrl missing

    return "#"; // Default fallback
};

// Resolve Links for Showreel Notes - Direct URLs
const vh1Url =
    "https://www.edexlive.com/breaking/2021/Jan/05/four-roommates-shot-a-music-video-in-their-mumbai-flat-and-it-received-a-premiere-on-vh1-17053.html";
const rollingStoneUrl =
    "https://rollingstoneindia.com/watch-electronic-pop-duo-xys-cinematic-video-for-debut-single-show-me-the-way/";
const homegrownUrl =
    "https://homegrown.co.in/homegrown-explore/when-creative-minds-collide-xys-show-me-the-way-music-video-is-visual-pleasure";
const educateGirlsUrl = findLink("Educate Girls");
const curvesColorsUrl = findLink("Curves and Colors");
const pursuitUrl = "https://www.pursuitofportraits.com/";
const hermosaUrl = "https://www.youtube.com/watch?v=EMsZT9PCFms";
const budweiserUrl = "https://www.weareanimal.co/budweiser-streetwear";
const wiedenUrl = findLink("Wieden");
const animalUrl = findLink("Animal");
const jawaUrl = "http://youtube.com/watch?v=CSmZHXpr13E";
const odishaUrl = "https://vimeo.com/265220711";
---

<BaseLayout title={pageTitle}>
    <!-- Force dark mode on landing page - core to the experience -->
    <ForceDarkMode />

    <!-- Consolidated Audio-Visual Experience Module -->
    <ExperienceModule
        client:media="(min-width: 769px)"
        client:only="react"
        src="https://jwipqbjxpmgyevfzpjjx.supabase.co/storage/v1/object/public/misc/music/landing-page-audio-01.mp3"
        captions={captionData}
    />
    <!-- Scroll-based volume control -->
    <AudioScrollVolume client:only="react" />
    <!-- Disable Liquid Cursor on mobile (touch devices don't need it and it's heavy) -->
    <LiquidCursor client:media="(min-width: 769px)" />

    <!-- ... styles ... -->

    <!-- 1. Centered Card Stack (Hidden on Mobile via CSS, now also JS prevented) -->
    <div class="card-stack-wrapper">
        <div class="snap-top"></div>
        <CardStacker
            client:only="react"
            images={featuredPhotography}
            anchorX="50%"
            anchorY="50%"
        />
        <div class="landing-overlays">
            <!-- Engagement triggered CTA -->
            <EngagementCTA client:only="react" />
            <!-- Bottom Scroll Hint -->
            <div class="scroll-hint">SCROLL DOWN</div>
        </div>
    </div>

    <!-- Spacer to push content below the "fold" -->
    <!-- Spacer to push content below the "fold" -->
    <!-- Increased to 90vh so it starts BELOW the images, then scrolls up into view -->
    <!-- Spacer to push content below the "fold" -->
    <div class="stack-spacer" style="height: 90vh;"></div>

    <!-- 2. The Narrative Section (Appears after scroll) -->
    <section class="narrative-section">
        <div class="hero-content">
            <h1 class="hero-title">
                Hi, I am Abodid. <br />
                My life revolves around... <br />
                <span id="typewriter-text" class="typing-text"></span>
            </h1>
        </div>

        <!-- 3. Bio / Next Page Content -->
        <div class="bio-content">
            <p>
                With over 8+ years of experience in photography, film and
                interactive media, I design authentic creative experiences for
                brands and organizations working in the culture and technology
                space.
            </p>
        </div>
    </section>

    <!-- Spacer at bottom -->
    <div class="bottom-spacer"></div>

    <!-- Showreel Section - Wrapped for Alignment -->
    <section class="section">
        <Showreel
            vh1Url={vh1Url}
            rollingStoneUrl={rollingStoneUrl}
            homegrownUrl={homegrownUrl}
            educateGirlsUrl={educateGirlsUrl}
            curvesColorsUrl={curvesColorsUrl}
            pursuitUrl={pursuitUrl}
            hermosaUrl={hermosaUrl}
            budweiserUrl={budweiserUrl}
            wiedenUrl={wiedenUrl}
            animalUrl={animalUrl}
            jawaUrl={jawaUrl}
            odishaUrl={odishaUrl}
        />

        <!-- Filmmaking Background Note -->
        <!-- Content moved to manifesto section - removed duplicate -->
    </section>

    <!-- Massive Spacer 3 (Showreel to Featured) -->
    <!-- Responsive Spacer -->
    <div class="responsive-spacer" aria-hidden="true"></div>

    <!-- Photo Stories -->
    <section class="section contained-section">
        <div class="section-header">
            <h2 class="section-title">Photographs by me that made a mark</h2>
            <a href="/photography" class="link-arrow mobile-btn">View All</a>
        </div>

        <!-- Contained Carousel Row 1 (Left) -->
        <PhotoGrid
            projects={featuredPhotography}
            maxItems={7}
            columns={2}
            contained={true}
        />
    </section>

    <!-- Blog Section -->
    <section class="section">
        <div class="section-header">
            <h2 class="section-title">
                Read some of the most read articles by me
            </h2>
            <a href="/blog" class="link-arrow mobile-btn">Read All</a>
        </div>

        <div class="blog-list">
            {
                recentPosts.map((post) => (
                    <a href={post.href} class="blog-card">
                        <div class="blog-image-wrapper">
                            {post.image ? (
                                <img
                                    src={post.image}
                                    alt={post.title}
                                    class="blog-image"
                                />
                            ) : (
                                <div class="blog-image-placeholder" />
                            )}
                        </div>

                        <div class="blog-content">
                            <span class="blog-date">{post.date}</span>
                            <h3 class="blog-title">{post.title}</h3>
                            <div class="blog-category">
                                {post.category &&
                                    (Array.isArray(post.category)
                                        ? post.category[0]
                                        : post.category)}
                            </div>
                        </div>

                        <div class="blog-action">
                            <span>VIEW MORE</span>
                            <span class="arrow">→</span>
                        </div>
                    </a>
                ))
            }
        </div>
    </section>
</BaseLayout>

<script>
    // ... existing typewriter script ...
</script>

<style>
    /* Fixed Positioning Layouts */
    .landing-overlays {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        pointer-events: none; /* Let clicks pass through to stack if needed */
        z-index: 10;
        transition: opacity 0.3s ease;
    }

    .hover-hint {
        position: absolute;
        top: 58%; /* Just below the center stack */
        left: 50%;
        transform: translateX(-50%);
        font-family: "Courier New", Courier, monospace;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.4);
        font-size: 0.8rem;
        letter-spacing: 0.05em;
    }

    .scroll-hint {
        position: absolute;
        bottom: 5vh; /* Strictly at bottom */
        left: 50%;
        transform: translateX(-50%);
        font-family: "Space Mono", monospace;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.6);
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
            transform: translateX(-50%) translateY(0);
        }
        40% {
            transform: translateX(-50%) translateY(-10px);
        }
        60% {
            transform: translateX(-50%) translateY(-5px);
        }
    }

    /* Narrative Section */
    .narrative-section {
        position: relative;
        z-index: 20;
        /* opacity: 0; */
        /* transform: translateY(50px); */
        /* will-change: opacity, transform; */
        padding-top: 10vh;
        /* Match standard container padding or remove completely if using contained-section class, 
           but here we use manual padding. User said "regular padding match showreel".
           Showreel on mobile respects parent padding (0 or 1.5rem). 
           Previously we had 1.5rem. Let's check strict alignment. */
        padding-left: 24px; /* Standard site padding */
        padding-right: 24px;
        min-height: auto;
        display: flex;
        flex-direction: column;
        gap: 6rem;
        max-width: 1100px; /* Align with other max-width containers */
        margin-left: auto;
        margin-right: auto;
    }

    /* Mobile Enhancements for Narrative */
    @media (max-width: 768px) {
        /* Hide Stack & Overlays */
        .card-stack-wrapper,
        .stack-spacer,
        .snap-top {
            display: none !important;
        }

        /* Hide Nav Cards */
        .nav-cards-section {
            display: none !important;
        }

        /* Narrative becomes Hero */
        .narrative-section {
            opacity: 1 !important; /* Always visible */
            transform: none !important;
            padding-top: 100px;
            /* REMOVED EXTRA PADDING: Now relies on parent .container (1.5rem) to match Showreel width */
            padding-left: 0;
            padding-right: 0;
            min-height: auto;
            margin-bottom: 2rem;
            width: 100%; /* Ensure full width */
            box-sizing: border-box;
        }

        .hero-title {
            font-size: 1.75rem !important; /* Reduced from 2rem */
            line-height: 1.3 !important;
            min-height: auto; /* Remove the flex/min-height hack on the container */
            display: block; /* Restore block layout */
        }

        /* Ensure distinct lines on mobile */
        .hero-title br {
            display: block;
            content: "";
            margin-bottom: 0.5rem;
        }

        #typewriter-text {
            display: block; /* Force new line */
            margin-top: 0.5rem;
            min-height: 10em; /* Generous reserve for 2-3 lines + buffer */
            height: 10em;
            overflow: hidden; /* Prevent spill */
            margin-bottom: 4rem; /* Reduced back to 4rem since height covers the 'gap' now, or keep 8? User said 'space added up remaining blank'. 8rem gave huge margin. 6em height gives huge internal space. Let's keep margin 4rem for balance if height is big. */
        }

        .bio-content p {
            font-size: 1.125rem !important; /* 18px */
            line-height: 1.5 !important;
        }

        /* Showreel Notes: Hide completely on mobile as requested */
        .note-grid {
            display: none !important;
        }

        /* Reduce spacer between Showreel & Featured */
        .section {
            margin-bottom: 4rem;
        }

        /* Blog List Item on Mobile */
        .blog-card {
            grid-template-columns: 1fr;
            /* REMOVE CARD PADDING concept */
            padding: 0;
            margin-left: 0vw; /* Align with global page gutter */
            margin-right: 0vw; /* Align with global page gutter */
            margin-bottom: 2rem; /* Just spacing between items */
            border-bottom: none; /* Remove separator line/card feel */
            gap: 0rem;
            /* Ensure NO extra borders or margins on the card itself */
            width: 100%; /* Allow margin to take effect */
        }

        .blog-list {
            display: flex;
            flex-direction: column;
            gap: 0; /* Stack cleanly */
            width: 100%;
            /* Ensure NO padding on list wrapper */
            padding: 0;
            margin: 0;
        }

        .blog-image-wrapper {
            width: 100%;
            height: 200px;
        }
        .blog-action {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }
    }

    .hero-title {
        font-family: var(--font-headline); /* Inherit or specific font */
        font-size: 3.5rem;
        font-weight: 700; /* Ensure Bold */
        line-height: 1.1;
        color: #fff;
    }

    .bio-content p {
        font-size: 2.2rem;
        font-weight: 300; /* Increased from 400 */
        line-height: 1.2;
        max-width: 900px;
        color: rgba(255, 255, 255, 0.95); /* Brighter/Bolder */
    }

    /* ... type writer styles ... */

    /* Desktop alignment for Showreel & Notes to match Narrative block width */
    /* REMOVED: Now handled by wrapper .section with padding */
    /* :global(.showreel-container),
    :global(.note-grid) {
        padding-left: 4vw;
        padding-right: 4vw;
    } */

    /* Spacer at bottom */
    .bottom-spacer {
        height: 25vh; /* Increased from 15vh for more gap before Showreel */
    }

    /* Typewriter Cursor */
    #typewriter-text::after {
        content: "";
        display: inline-block;
        width: 12px;
        height: 1em;
        background-color: currentColor;
        margin-left: 5px;
        animation: blink 1s infinite;
        vertical-align: text-bottom;
    }

    @keyframes blink {
        0%,
        50% {
            opacity: 1;
        }
        51%,
        100% {
            opacity: 0;
        }
    }

    @media (max-width: 768px) {
        .hero-title {
            font-size: 2.5rem;
            min-height: auto;
        }
        .intro-content p {
            font-size: 1.5rem;
        }
        .blog-card {
            grid-template-columns: 100px 1fr;
            padding: 1.5rem;
            gap: 1.5rem;
        }
        .blog-action {
            display: none;
        }
        .blog-image-wrapper {
            width: 100px;
            height: 100px;
        }
        .blog-title {
            font-size: 1.2rem;
        }
        /* Hide Vibe Check on mobile */
    }

    .italic {
        font-style: italic;
        font-weight: 400;
    }

    .section {
        margin-bottom: var(--space-2xl);
        /* Ensure sections align with the grid */
        max-width: 1100px;
        margin-left: auto;
        margin-right: auto;
        padding-left: 24px;
        padding-right: 24px;
    }

    .contained-section {
        /* Inherits padding from .section or explicit override? 
           Let's just use .section styles for all mainly, but if contained-section was separate: */
        padding-left: 24px;
        padding-right: 24px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: var(--space-lg);
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: var(--space-md);
        /* Remove margin-left/right if any existed */
    }

    @media (max-width: 600px) {
        .section-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem; /* TIGHTER gap between title and button */
            margin-bottom: 1rem; /* Compact header */
        }

        /* Mobile Spacing for Sections - REMOVED EXTRA PADDING to align with Showreel */
        .section,
        .contained-section {
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        .section-title {
            font-size: 2rem; /* Ensure it fits one line if possible, or wrap cleanly */
            line-height: 1.1;
        }

        /* Minimal Sleek Button Mobile */
        .mobile-btn {
            display: inline-block;
            width: auto;
            text-align: left;
            padding: 0; /* Remove button padding */
            border: none; /* Remove border */
            background: none;
            margin-top: 0;
            font-size: 0.7rem; /* Tiny text */
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: rgba(255, 255, 255, 0.6); /* Subtle color */
            font-weight: 400;
        }

        .mobile-btn::after {
            content: " →";
            display: inline;
            opacity: 0.6;
        }
    }

    .link-arrow {
        font-size: var(--text-sm);
        font-weight: 500;
        position: relative;
        padding-right: 1.2em;
    }

    .link-arrow::after {
        content: "→";
        position: absolute;
        right: 0;
        transition: transform 0.2s ease;
    }

    .link-arrow:hover::after {
        transform: translateX(4px);
    }

    .blog-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .blog-card {
        display: grid;
        grid-template-columns: 200px 1fr auto;
        gap: 2rem;
        padding: 1.5rem 0; /* Remove side padding for cleaner alignment with header */
        text-decoration: none;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-subtle); /* Subtle separator instead of box */
        /* border-radius removed */
        transition: transform 0.3s ease;
        align-items: center;
    }

    .blog-card:hover {
        transform: translateY(-2px);
        /* border-color removed */
    }

    .blog-image-wrapper {
        width: 200px;
        height: 200px;
        overflow: hidden;
        border-radius: 6px;
        background: var(--bg-surface);
    }

    .blog-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .blog-image-placeholder {
        width: 100%;
        height: 100%;
        background: var(--bg-surface);
    }

    .blog-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .blog-date {
        font-family: "Inconsolata", monospace;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-tertiary);
        margin-bottom: 0.5rem;
    }

    .blog-title {
        font-family: var(--font-serif);
        font-size: 1.5rem;
        font-weight: 400;
        line-height: 1.2;
        margin: 0 0 0.5rem 0;
    }

    .blog-category {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .blog-action {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: var(--text-tertiary);
        transition: color 0.3s ease;
    }

    .blog-card:hover .blog-action {
        color: var(--text-primary);
    }

    .blog-card:hover .arrow {
        transform: translateX(4px);
        transition: transform 0.2s ease;
    }

    /* Typewriter Text Styling */
    #typewriter-text {
        font-size: 1.35em; /* Slightly reduced */
        display: inline-block;
        min-height: 1.2em; /* Reserve space */
        margin-top: 0;
        position: relative;
        top: -2px; /* Shift upwards to balance */
        white-space: nowrap; /* Prevent wrapping to next line */

        /* Smooth text removal - adjust transition duration */
        transition: opacity 0.1s ease; /* Makes disappearance smoother */
    }

    @media (max-width: 600px) {
        #typewriter-text {
            white-space: normal; /* Allow wrapping on mobile */
            word-break: break-word;
            display: inline; /* changing to inline allows wrapping naturally */
        }
    }

    #typewriter-text span {
        /* Smooth individual character removal */
        transition: opacity 0.08s ease;
        /* Soft blur shadow to make text pop more as requested */
        text-shadow: 0 0 10px currentColor;
    }

    /* Typewriter Cursor - Customizable */
    #typewriter-text::after {
        content: "";
        display: inline-block;

        /* Cursor dimensions - adjust these */
        width: 14px; /* Width of cursor */
        height: 0.8em; /* Height of cursor */

        /* Cursor appearance */
        background-color: var(--text-primary);
        border-radius: 1px;

        /* Positioning */
        margin-left: 5px; /* Space from text */
        vertical-align: top; /* Align with text baseline */
        position: relative;
        top: 0.1em; /* Fine-tune vertical position */

        /* Animation */
        animation: blink 1.2s infinite; /* Slightly slower blink for calmer feel */
    }

    @keyframes blink {
        0%,
        50% {
            opacity: 1;
        }
        51%,
        100% {
            opacity: 0;
        }
    }

    @media (max-width: 768px) {
        .hero-title {
            font-size: 2.5rem;
            min-height: auto;
        }
        .intro-content p {
            font-size: 1.5rem;
        }
        .blog-card {
            grid-template-columns: 100px 1fr;
            padding: 1.5rem;
            gap: 1.5rem;
        }
        .blog-action {
            display: none;
        }
        .blog-image-wrapper {
            width: 100px;
            height: 100px;
        }
        .blog-title {
            font-size: 1.2rem;
        }
        /* Hide Vibe Check on mobile */
        .vibe-check-wrapper {
            display: none;
        }
    }

    @media (max-width: 500px) {
        .blog-card {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .blog-image-wrapper {
            width: 100%;
            height: 200px;
        }
    }

    .note-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;

        max-width: 1100px;
        margin: 3rem auto;
    }

    .showreel-note {
        font-family: "Inconsolata", monospace;
        font-size: 0.95rem;
        line-height: 1.6;

        color: #ffffff;

        border: 1px solid rgba(255, 255, 255, 0.6);
        border-radius: 8px;

        padding: 1.25rem 1.5rem;

        backdrop-filter: blur(2px);

        letter-spacing: 0.02em;
    }

    .note-primary {
        background-color: rgba(178, 28, 48, 0.881);
    }

    .note-secondary {
        background-color: rgba(39, 24, 138, 0.941);
    }

    .showreel-note p {
        margin: 0;
    }

    @media (max-width: 768px) {
        .note-grid {
            grid-template-columns: 1fr;
        }
    }

    .note-grid {
        display: grid;
        grid-template-columns: 1fr 1fr !important;
        gap: 1.5rem;

        max-width: 1100px;
        margin: 3rem auto;

        padding: 0; /* ← THIS is the key line */
    }

    .responsive-spacer {
        height: 20vh;
        width: 100%;
    }

    @media (max-width: 768px) {
        .responsive-spacer {
            height: 5vh; /* Drastically reduce on mobile */
        }
    }

    .showreel-note .line-gap {
        display: block;
        height: 1rem;
    }

    /* Link that looks like underlined white text + "selection fill" hover */
    .hl-link {
        color: #fff;
        text-decoration: underline;
        text-decoration-thickness: 1px;
        text-underline-offset: 3px;

        position: relative;
        display: inline-block;
        padding: 0 0.12em; /* tiny padding so highlight looks intentional */
        border-radius: 2px; /* subtle rounding like a selection */
        cursor: pointer;

        /* remove default link focus outline styling differences across browsers */
        outline: none;
    }

    /* Background "fill" on hover like text selection */
    .hl-link::before {
        content: "";
        position: absolute;
        left: 0;
        bottom: 0.05em;
        width: 100%;
        height: 1.1em;
        background: rgba(255, 255, 255, 0.22); /* selection-like fill */
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 160ms ease;
        border-radius: 2px;
        z-index: -1; /* keep fill behind text */
    }

    .hl-link:hover::before {
        transform: scaleX(1);
    }

    /* Optional: slightly stronger on active click */
    .hl-link:active::before {
        background: rgba(255, 255, 255, 0.35);
    }

    /* Accessible keyboard focus */
    .hl-link:focus-visible {
        box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.35);
        border-radius: 4px;
    }

    /* Refined hero / statement font styling — matched to image */
</style>

<script>
    // --- Scroll Hint Fade Logic ---
    const scrollHint = document.querySelector(".scroll-hint");
    const landingOverlays = document.querySelector(".landing-overlays");
    const narrativeSection = document.querySelector(".narrative-section");

    window.addEventListener("scroll", () => {
        const y = window.scrollY;

        // 1. Fade out Landing Overlays quickly
        const overlayOpacity = Math.max(0, 1 - y / 200);
        if (landingOverlays) {
            landingOverlays.style.opacity = overlayOpacity.toString();
            landingOverlays.style.pointerEvents =
                overlayOpacity <= 0 ? "none" : "auto";
        }

        // 2. Fade IN Narrative Section after cards flick away
        // Delayed: Starts after ~2 swipes (200px)
        if (narrativeSection) {
            const startFade = 200;
            const endFade = 700;
            let opacity = 0;
            let translateY = 50;

            if (y > startFade) {
                const ratio = Math.min(
                    1,
                    Math.max(0, (y - startFade) / (endFade - startFade)),
                );
                opacity = ratio;
                translateY = 50 - ratio * 50;
            }
            narrativeSection.style.opacity = opacity.toString();
            narrativeSection.style.transform = `translateY(${translateY}px)`;
        }
    });

    // --- Typewriter Logic (Ported from index.astro) ---
    // User requested "The High I am about it, my life revolves around..."
    // content structure is reused from main page logic.

    const phrases = [
        "Images, Code & Culture.",
        "Design & Technology.",
        "Writing & Storytelling.",
        "Travel, Fashion & Music.",
        "Photography, Film & Art.",
        "AI, Sociology & Research.",
    ];

    const colors = [
        "#D35E7F", // Cinnamon Satin
        "#D7E97B", // Manz
        "#A999EB", // Max Blue Purple
        "#9BCDEF", // Baby Blue Eyes
    ];

    const typingSpeed = { min: 40, max: 100 };
    const backspaceSpeed = { min: 30, max: 50 };
    const pauseEnd = 2000;
    const pauseStart = 500;

    const textElement = document.getElementById("typewriter-text");

    let phraseIndex = 0;
    let charIndex = 0;
    let isDeleting = false;
    let currentPhraseObjects = [];

    function parsePhrase(phrase) {
        const words = phrase.split(" ");
        let phraseColors = [...colors];

        // Simple shuffle for variety
        phraseColors.sort(() => Math.random() - 0.5);

        // Ensure we have enough colors
        while (phraseColors.length < words.length) {
            phraseColors = phraseColors.concat(
                [...colors].sort(() => Math.random() - 0.5),
            );
        }

        return words.map((word, i) => {
            return {
                text: word + " ",
                color: phraseColors[i],
            };
        });
    }

    function renderText() {
        if (!textElement) return;
        let charCount = 0;
        let html = "";

        for (let obj of currentPhraseObjects) {
            if (charCount >= charIndex) break;
            const remaining = charIndex - charCount;
            const textToDisplay = obj.text.substring(0, remaining);
            html += `<span style="color: ${obj.color}">${textToDisplay}</span>`;
            charCount += obj.text.length;
            if (charCount > charIndex) break;
        }
        textElement.innerHTML = html;
    }

    function getTotalLength() {
        return currentPhraseObjects.reduce(
            (acc, obj) => acc + obj.text.length,
            0,
        );
    }

    function type() {
        if (!textElement) return;

        if (charIndex === 0 && !isDeleting) {
            currentPhraseObjects = parsePhrase(phrases[phraseIndex]);
        }

        const totalLen = getTotalLength();
        let speed =
            Math.random() * (typingSpeed.max - typingSpeed.min) +
            typingSpeed.min;

        if (isDeleting) {
            charIndex--;
            renderText();
            speed =
                Math.random() * (backspaceSpeed.max - backspaceSpeed.min) +
                backspaceSpeed.min;
        } else {
            charIndex++;
            renderText();
        }

        if (!isDeleting && charIndex === totalLen) {
            isDeleting = true;
            setTimeout(type, pauseEnd);
        } else if (isDeleting && charIndex === 0) {
            isDeleting = false;
            phraseIndex = (phraseIndex + 1) % phrases.length;
            setTimeout(type, pauseStart);
        } else {
            setTimeout(type, speed);
        }
    }

    // Start typewriter
    setTimeout(type, 1000);
</script>
