---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../styles/resources.css";

const title = "Login | Resource Hub";
---

<BaseLayout title={title}>
    <div class="login-container">
        <div class="login-card">
            <h1 class="hub-title" id="page-title">Curator Login</h1>
            <p class="hub-subtitle" id="page-subtitle">
                Log in to continue your curation journey.
            </p>

            <form id="auth-form" method="POST">
                {/* Full Name - Hidden by default (Login Mode) */}
                <div
                    class="hub-form-group"
                    id="name-group"
                    style="display: none;"
                >
                    <label class="hub-label">Full Name</label>
                    <input
                        type="text"
                        id="fullname"
                        class="hub-input"
                        placeholder="Jane Doe"
                    />
                </div>

                <div class="hub-form-group">
                    <label class="hub-label">Email Address</label>
                    <input
                        type="email"
                        id="email"
                        class="hub-input"
                        required
                        placeholder="you@example.com"
                    />
                </div>

                <div class="hub-form-group">
                    <label class="hub-label">Password</label>
                    <input
                        type="password"
                        id="password"
                        class="hub-input"
                        required
                        placeholder="••••••••"
                        minlength="6"
                    />
                </div>

                <button type="submit" class="hub-btn" id="submit-btn">
                    Log In
                </button>
            </form>

            <div id="message" class="auth-message" style="display: none;"></div>

            <div class="toggle-mode-wrapper">
                <p class="toggle-text">
                    <span id="switch-text">Don't have an account?</span>
                    <button id="mode-toggle" class="toggle-btn">Sign Up</button>
                </p>
            </div>
        </div>
    </div>
</BaseLayout>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
        padding: 24px;
    }

    .login-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 24px;
        padding: 64px;
        width: 100%;
        max-width: 580px;
        text-align: center;
        box-shadow: 0 4px 40px rgba(0, 0, 0, 0.08);
    }

    .hub-title {
        font-family: var(--font-sans);
        font-size: 3.5rem; /* Very Large Font */
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 16px;
        letter-spacing: -0.04em;
        line-height: 1.1;
    }

    .hub-subtitle {
        font-family: var(--font-sans);
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 48px;
        line-height: 1.6;
    }

    .hub-form-group {
        margin-bottom: 24px;
        text-align: left;
    }

    .hub-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .hub-input {
        width: 100%;
        padding: 16px;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        font-size: 1.1rem;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .hub-input:focus {
        outline: none;
        border-color: var(--text-primary);
        box-shadow: 0 0 0 4px var(--bg-surface-hover);
    }

    .hub-btn {
        width: 100%;
        padding: 18px;
        background: var(--text-primary);
        color: var(--bg-surface);
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        margin-top: 16px;
        transition: opacity 0.2s ease;
    }

    html[data-theme="light"] .hub-btn {
        background-color: #000000;
        color: #ffffff;
    }
    html[data-theme="dark"] .hub-btn {
        background: #ffffff;
        color: #000000;
    }

    .hub-btn:hover {
        opacity: 0.9;
    }

    .auth-message {
        margin-top: 24px;
        padding: 16px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .toggle-mode-wrapper {
        margin-top: 40px;
        padding-top: 24px;
        border-top: 1px solid var(--border-subtle);
    }

    .toggle-text {
        font-size: 1rem;
        color: var(--text-secondary);
    }

    .toggle-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        font-weight: 700;
        cursor: pointer;
        text-decoration: underline;
        margin-left: 8px;
        font-size: inherit;
    }

    @media (max-width: 600px) {
        .login-card {
            padding: 40px 24px;
        }
        .hub-title {
            font-size: 2.5rem;
        }
    }
</style>

<script>
    import { supabase } from "../lib/supabaseClient";

    // --- STATE ---
    let isSignup = false;
    let isLinking = false;

    // --- ELEMENTS ---
    const form = document.getElementById("auth-form");
    const messageEl = document.getElementById("message");
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    const toggleBtn = document.getElementById("mode-toggle");
    const nameGroup = document.getElementById("name-group");
    const pageTitle = document.getElementById("page-title");
    const pageSubtitle = document.getElementById("page-subtitle");
    const switchText = document.getElementById("switch-text");
    const fullNameInput = document.getElementById(
        "fullname",
    ) as HTMLInputElement;

    // --- HELPERS ---
    const showMsg = (msg: string, type: "success" | "error") => {
        if (!messageEl) return;
        messageEl.style.display = "block";
        messageEl.innerText = msg;
        messageEl.style.background = type === "error" ? "#fee2e2" : "#dcfce7";
        messageEl.style.color = type === "error" ? "#b91c1c" : "#166534";
    };

    const toggleMode = (forceSignup?: boolean) => {
        if (forceSignup !== undefined) {
            isSignup = forceSignup;
        } else {
            isSignup = !isSignup;
        }

        if (isSignup) {
            nameGroup!.style.display = "block";
            if (!isLinking) {
                pageTitle!.innerText = "Join the Ecosystem";
                pageSubtitle!.innerText =
                    "Create an account to save and share resources.";
            }
            submitBtn!.innerText = "Create Account";
            switchText!.innerText = "Already have an account?";
            toggleBtn!.innerText = "Log In";
            fullNameInput?.setAttribute("required", "true");
        } else {
            nameGroup!.style.display = "none";
            pageTitle!.innerText = "Curator Login";
            pageSubtitle!.innerText =
                "Log in to continue your curation journey.";
            submitBtn!.innerText = "Log In";
            switchText!.innerText = "Don't have an account?";
            toggleBtn!.innerText = "Sign Up";
            fullNameInput?.removeAttribute("required");
        }

        if (messageEl) messageEl.style.display = "none";
    };

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!supabase) return;

        submitBtn.disabled = true;
        submitBtn.innerText = isSignup ? "Creating..." : "Logging in...";

        const email = (document.getElementById("email") as HTMLInputElement)
            .value;
        const password = (
            document.getElementById("password") as HTMLInputElement
        ).value;
        const fullName = fullNameInput.value;
        let result;

        try {
            if (isSignup) {
                if (isLinking) {
                    // Upgrade Anonymous -> Real
                    result = await supabase.auth.updateUser({
                        email,
                        password,
                        data: { full_name: fullName },
                    });
                } else {
                    // New Signup
                    result = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: { full_name: fullName },
                        },
                    });
                }
            } else {
                // Log In
                result = await supabase.auth.signInWithPassword({
                    email,
                    password,
                });
            }

            const { data, error } = result;
            if (error) throw error;

            const hasSession = (data as any).session || isLinking;

            if (isSignup && !hasSession && !isLinking) {
                showMsg(
                    "Account created! Please check your email to confirm.",
                    "success",
                );
                submitBtn.innerText = "Check Email";
            } else {
                if (isLinking) {
                    // Manually ensure profile exists (upsert)
                    await supabase.from("profiles").upsert({
                        id: (data.user as any)?.id,
                        username: email.split("@")[0],
                        full_name: fullName,
                        role: "user",
                    });
                }

                showMsg("Success! Redirecting...", "success");

                // Smart redirect based on user role
                const { data: profile } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", (data.user as any)?.id)
                    .single();

                const params = new URLSearchParams(window.location.search);
                const redirect = params.get("redirect");

                if (redirect) {
                    window.location.assign(redirect);
                } else if (profile?.role === "admin") {
                    // Admins logging in via main login should probably go to Admin Dashboard,
                    // or Unified Dashboard? Let's send them to Unified for now as it has a link to Admin.
                    window.location.assign("/resources/dashboard");
                } else if (profile?.role === "curator") {
                    window.location.assign("/resources/dashboard");
                } else {
                    window.location.assign("/resources/dashboard");
                }
            }
        } catch (error: any) {
            if (error.message.includes("Invalid login credentials")) {
                showMsg(
                    isSignup
                        ? "Error: This email might already be in use."
                        : "Invalid email or password.",
                    "error",
                );
            } else {
                showMsg(error.message, "error");
            }
            submitBtn.disabled = false;
            submitBtn.innerText = isSignup ? "Create Account" : "Log In";
        }
    });

    toggleBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        toggleMode();
    });

    // --- INIT ---
    const initPage = async () => {
        if (!supabase) return;

        const params = new URLSearchParams(window.location.search);
        const mode = params.get("mode");
        const link = params.get("link");

        const {
            data: { session },
        } = await supabase.auth.getSession();
        const isAnonymous = session?.user?.is_anonymous;

        if (link === "true" && isAnonymous) {
            isLinking = true;
            // console.log("Upgrading anonymous account...");
            toggleMode(true);
            if (pageTitle) pageTitle.innerText = "Save Your Progress";
            if (pageSubtitle)
                pageSubtitle.innerText =
                    "Create an account to save your bookmarks & upvotes forever.";
        } else if (mode === "signup") {
            toggleMode(true);
        }
    };

    initPage();
</script>
