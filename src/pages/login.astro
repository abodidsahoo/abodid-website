---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../styles/resources.css";

const title = "Login | Resource Hub";
---

<BaseLayout title={title}>
    <div class="login-container">
        <div class="login-card">
            <h1 class="hub-title" id="page-title">Curator Login</h1>
            <p class="hub-subtitle" id="page-subtitle">
                Log in to continue your curation journey.
            </p>

            <form id="auth-form" method="POST">
                {/* Full Name - Hidden by default (Login Mode) */}
                <div
                    class="hub-form-group"
                    id="name-group"
                    style="display: none;"
                >
                    <label class="hub-label">Full Name</label>
                    <input
                        type="text"
                        id="fullname"
                        class="hub-input"
                        placeholder="Jane Doe"
                        maxlength="80"
                    />
                    <p class="field-hint">
                        Use letters, spaces, apostrophes, or hyphens.
                    </p>
                    <p
                        id="name-error"
                        class="field-error"
                        style="display: none;"
                    >
                    </p>
                </div>

                <div class="hub-form-group" id="email-group">
                    <label class="hub-label">Email Address</label>
                    <input
                        type="email"
                        id="email"
                        class="hub-input"
                        required
                        placeholder="you@example.com"
                    />
                    <p class="field-hint">
                        Email can include numbers and symbols.
                    </p>
                    <p
                        id="email-error"
                        class="field-error"
                        style="display: none;"
                    >
                    </p>
                </div>

                <div class="hub-form-group" id="password-group">
                    <label class="hub-label" id="password-label">Password</label
                    >
                    <div class="password-field">
                        <input
                            type="password"
                            id="password"
                            class="hub-input"
                            required
                            placeholder="••••••••"
                            minlength="6"
                            autocomplete="current-password"
                        />
                        <button
                            type="button"
                            id="password-toggle"
                            class="password-toggle"
                            aria-label="Show password"
                            aria-pressed="false"
                        >
                            <svg
                                id="eye-open"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                            >
                                <path
                                    d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"
                                ></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                            <svg
                                id="eye-closed"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                style="display: none;"
                            >
                                <path d="M3 3l18 18"></path>
                                <path d="M10.6 10.6a2 2 0 1 0 2.8 2.8"></path>
                                <path
                                    d="M9.4 5.2A10.6 10.6 0 0 1 12 5c6.5 0 10 7 10 7a16.5 16.5 0 0 1-3.2 4.3"
                                ></path>
                                <path
                                    d="M6.7 6.7C4.3 8.2 2.8 10.7 2 12c0 0 3.5 7 10 7 1.7 0 3.2-.5 4.5-1.2"
                                ></path>
                            </svg>
                        </button>
                    </div>
                    <p id="password-hint" class="field-hint">
                        Minimum 6 characters.
                    </p>
                    <p
                        id="password-error"
                        class="field-error"
                        style="display: none;"
                    >
                    </p>
                </div>

                <div
                    class="hub-form-group"
                    id="confirm-password-group"
                    style="display: none;"
                >
                    <label class="hub-label">Confirm New Password</label>
                    <input
                        type="password"
                        id="confirm-password"
                        class="hub-input"
                        placeholder="••••••••"
                        minlength="6"
                        autocomplete="new-password"
                    />
                    <p class="field-hint">Re-enter your new password.</p>
                    <p
                        id="confirm-password-error"
                        class="field-error"
                        style="display: none;"
                    >
                    </p>
                </div>

                <div class="form-actions-row" id="forgot-action-row">
                    <button
                        type="button"
                        id="forgot-password-btn"
                        class="inline-action-btn"
                    >
                        Forgot password?
                    </button>
                </div>

                <button type="submit" class="hub-btn" id="submit-btn">
                    Log In
                </button>
            </form>

            <div id="message" class="auth-message" style="display: none;"></div>

            <div class="toggle-mode-wrapper" id="toggle-mode-wrapper">
                <p class="toggle-text">
                    <span id="switch-text">Don't have an account?</span>
                    <button id="mode-toggle" class="toggle-btn">Sign Up</button>
                </p>
            </div>
        </div>
    </div>
</BaseLayout>

<style>
    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 80vh;
        padding: 24px;
    }

    .login-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 24px;
        padding: 64px;
        width: 100%;
        max-width: 580px;
        text-align: center;
        box-shadow: 0 4px 40px rgba(0, 0, 0, 0.08);
    }

    .hub-title {
        font-family: var(--font-sans);
        font-size: 3.5rem; /* Very Large Font */
        font-weight: 800;
        color: var(--text-primary);
        margin-bottom: 16px;
        letter-spacing: -0.04em;
        line-height: 1.1;
    }

    .hub-subtitle {
        font-family: var(--font-sans);
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-bottom: 48px;
        line-height: 1.6;
    }

    .hub-form-group {
        margin-bottom: 24px;
        text-align: left;
    }

    .hub-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .hub-input {
        width: 100%;
        padding: 16px;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        font-size: 1.1rem;
        color: var(--text-primary);
        transition: all 0.2s ease;
    }

    .hub-input:focus {
        outline: none;
        border-color: var(--text-primary);
        box-shadow: 0 0 0 4px var(--bg-surface-hover);
    }

    .hub-input.is-invalid {
        border-color: #dc2626;
        box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.12);
    }

    .field-hint {
        margin-top: 8px;
        margin-bottom: 0;
        color: var(--text-secondary);
        font-size: 0.85rem;
        line-height: 1.4;
    }

    .field-hint.is-warning {
        color: #b45309;
    }

    .field-hint.is-success {
        color: #15803d;
    }

    .field-error {
        margin-top: 8px;
        margin-bottom: 0;
        color: #dc2626;
        font-size: 0.85rem;
        line-height: 1.4;
    }

    .password-field {
        position: relative;
    }

    .password-field .hub-input {
        padding-right: 52px;
    }

    .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 6px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .password-toggle:hover {
        color: var(--text-primary);
        background: var(--bg-surface-hover);
    }

    .password-toggle svg {
        width: 18px;
        height: 18px;
    }

    .hub-btn {
        width: 100%;
        padding: 18px;
        background: var(--text-primary);
        color: var(--bg-surface);
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        margin-top: 16px;
        transition: opacity 0.2s ease;
    }

    html[data-theme="light"] .hub-btn {
        background-color: #000000;
        color: #ffffff;
    }
    html[data-theme="dark"] .hub-btn {
        background: #ffffff;
        color: #000000;
    }

    .hub-btn:hover {
        opacity: 0.9;
    }

    .form-actions-row {
        display: flex;
        justify-content: flex-end;
        margin-top: -8px;
        margin-bottom: 8px;
    }

    .inline-action-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: underline;
        padding: 0;
    }

    .inline-action-btn:hover {
        opacity: 0.8;
    }

    .auth-message {
        margin-top: 24px;
        padding: 16px;
        border-radius: 12px;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .toggle-mode-wrapper {
        margin-top: 40px;
        padding-top: 24px;
        border-top: 1px solid var(--border-subtle);
    }

    .toggle-text {
        font-size: 1rem;
        color: var(--text-secondary);
    }

    .toggle-btn {
        background: none;
        border: none;
        color: var(--text-primary);
        font-weight: 700;
        cursor: pointer;
        text-decoration: underline;
        margin-left: 8px;
        font-size: inherit;
    }

    @media (max-width: 600px) {
        .login-card {
            padding: 40px 24px;
        }
        .hub-title {
            font-size: 2.5rem;
        }
    }
</style>

<script>
    import { supabase } from "../lib/supabaseClient";

    type AuthMode = "login" | "signup" | "forgot" | "reset";

    // --- STATE ---
    let authMode: AuthMode = "login";
    let isLinking = false;

    // --- ELEMENTS ---
    const form = document.getElementById("auth-form");
    const messageEl = document.getElementById("message");
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    const toggleBtn = document.getElementById("mode-toggle");
    const toggleWrapper = document.getElementById("toggle-mode-wrapper");
    const nameGroup = document.getElementById("name-group");
    const emailGroup = document.getElementById("email-group");
    const passwordGroup = document.getElementById("password-group");
    const passwordLabel = document.getElementById("password-label");
    const confirmPasswordGroup = document.getElementById(
        "confirm-password-group",
    );
    const forgotActionRow = document.getElementById("forgot-action-row");
    const forgotPasswordBtn = document.getElementById("forgot-password-btn");
    const pageTitle = document.getElementById("page-title");
    const pageSubtitle = document.getElementById("page-subtitle");
    const switchText = document.getElementById("switch-text");
    const fullNameInput = document.getElementById(
        "fullname",
    ) as HTMLInputElement;
    const emailInput = document.getElementById("email") as HTMLInputElement;
    const passwordInput = document.getElementById(
        "password",
    ) as HTMLInputElement;
    const confirmPasswordInput = document.getElementById(
        "confirm-password",
    ) as HTMLInputElement;
    const nameErrorEl = document.getElementById("name-error");
    const emailErrorEl = document.getElementById("email-error");
    const passwordErrorEl = document.getElementById("password-error");
    const confirmPasswordErrorEl = document.getElementById(
        "confirm-password-error",
    );
    const passwordHintEl = document.getElementById("password-hint");
    const passwordToggleBtn = document.getElementById(
        "password-toggle",
    ) as HTMLButtonElement;
    const eyeOpenEl = document.getElementById("eye-open");
    const eyeClosedEl = document.getElementById("eye-closed");
    let isPasswordVisible = false;

    // --- HELPERS ---
    const showMsg = (msg: string, type: "success" | "error") => {
        if (!messageEl) return;
        messageEl.style.display = "block";
        messageEl.innerText = msg;
        messageEl.style.background = type === "error" ? "#fee2e2" : "#dcfce7";
        messageEl.style.color = type === "error" ? "#b91c1c" : "#166534";
    };

    const clearMsg = () => {
        if (!messageEl) return;
        messageEl.style.display = "none";
        messageEl.innerText = "";
    };

    const setFieldError = (
        input: HTMLInputElement | null,
        errorEl: HTMLElement | null,
        message: string,
    ) => {
        if (input) input.classList.add("is-invalid");
        if (errorEl) {
            errorEl.innerText = message;
            errorEl.style.display = "block";
        }
    };

    const clearFieldError = (
        input: HTMLInputElement | null,
        errorEl: HTMLElement | null,
    ) => {
        if (input) input.classList.remove("is-invalid");
        if (errorEl) {
            errorEl.innerText = "";
            errorEl.style.display = "none";
        }
    };

    const setVisibility = (
        element: HTMLElement | null,
        visible: boolean,
        visibleDisplay: string = "block",
    ) => {
        if (!element) return;
        element.style.display = visible ? visibleDisplay : "none";
    };

    const clearAllFieldErrors = () => {
        clearFieldError(fullNameInput, nameErrorEl);
        clearFieldError(emailInput, emailErrorEl);
        clearFieldError(passwordInput, passwordErrorEl);
        clearFieldError(confirmPasswordInput, confirmPasswordErrorEl);
    };

    const updatePasswordHint = (passwordLength: number) => {
        if (!passwordHintEl) return;
        passwordHintEl.classList.remove("is-warning", "is-success");

        if (passwordLength === 0) {
            passwordHintEl.innerText = "Minimum 6 characters.";
            return;
        }

        if (passwordLength < 6) {
            passwordHintEl.innerText = `Minimum 6 characters (${passwordLength}/6).`;
            passwordHintEl.classList.add("is-warning");
            return;
        }

        passwordHintEl.innerText = `Password length looks good (${passwordLength} characters).`;
        passwordHintEl.classList.add("is-success");
    };

    const syncPasswordVisibility = () => {
        if (!passwordInput || !passwordToggleBtn) return;
        passwordInput.type = isPasswordVisible ? "text" : "password";
        passwordToggleBtn.setAttribute(
            "aria-label",
            isPasswordVisible ? "Hide password" : "Show password",
        );
        passwordToggleBtn.setAttribute(
            "aria-pressed",
            isPasswordVisible ? "true" : "false",
        );
        if (eyeOpenEl)
            eyeOpenEl.style.display = isPasswordVisible ? "none" : "block";
        if (eyeClosedEl)
            eyeClosedEl.style.display = isPasswordVisible ? "block" : "none";
    };

    const getSubmitText = (mode: AuthMode, isLoading: boolean = false) => {
        if (mode === "signup")
            return isLoading ? "Creating..." : "Create Account";
        if (mode === "forgot")
            return isLoading ? "Sending..." : "Send Reset Link";
        if (mode === "reset")
            return isLoading ? "Saving..." : "Save New Password";
        return isLoading ? "Logging in..." : "Log In";
    };

    const setMode = (
        mode: AuthMode,
        options?: { preserveMessage?: boolean },
    ) => {
        authMode = mode;

        const showName = mode === "signup";
        const showEmail = mode !== "reset";
        const showPassword = mode !== "forgot";
        const showConfirmPassword = mode === "reset";
        const showForgotAction = mode === "login";
        const showToggle = mode !== "reset";

        setVisibility(nameGroup, showName);
        setVisibility(emailGroup, showEmail);
        setVisibility(passwordGroup, showPassword);
        setVisibility(confirmPasswordGroup, showConfirmPassword);
        setVisibility(forgotActionRow, showForgotAction, "flex");
        setVisibility(toggleWrapper, showToggle);

        if (fullNameInput) {
            if (showName) fullNameInput.setAttribute("required", "true");
            else fullNameInput.removeAttribute("required");
        }

        if (emailInput) {
            if (showEmail) emailInput.setAttribute("required", "true");
            else emailInput.removeAttribute("required");
        }

        if (passwordInput) {
            if (showPassword) passwordInput.setAttribute("required", "true");
            else passwordInput.removeAttribute("required");

            passwordInput.setAttribute(
                "autocomplete",
                mode === "login" ? "current-password" : "new-password",
            );
        }

        if (confirmPasswordInput) {
            if (showConfirmPassword) {
                confirmPasswordInput.setAttribute("required", "true");
                confirmPasswordInput.value = "";
            } else {
                confirmPasswordInput.removeAttribute("required");
            }
        }

        if (mode === "signup") {
            if (!isLinking) {
                if (pageTitle) pageTitle.innerText = "Join the Ecosystem";
                if (pageSubtitle) {
                    pageSubtitle.innerText =
                        "Create an account to save and share resources.";
                }
            }
            if (switchText) switchText.innerText = "Already have an account?";
            if (toggleBtn) toggleBtn.innerText = "Log In";
            if (passwordLabel) passwordLabel.innerText = "Password";
        } else if (mode === "forgot") {
            if (pageTitle) pageTitle.innerText = "Reset Your Password";
            if (pageSubtitle) {
                pageSubtitle.innerText =
                    "Enter your email and we will send a secure reset link.";
            }
            if (switchText) switchText.innerText = "Remembered your password?";
            if (toggleBtn) toggleBtn.innerText = "Log In";
            if (passwordLabel) passwordLabel.innerText = "Password";
        } else if (mode === "reset") {
            if (pageTitle) pageTitle.innerText = "Set New Password";
            if (pageSubtitle) {
                pageSubtitle.innerText =
                    "Choose a strong new password for your account.";
            }
            if (passwordLabel) passwordLabel.innerText = "New Password";
        } else {
            if (pageTitle) pageTitle.innerText = "Curator Login";
            if (pageSubtitle) {
                pageSubtitle.innerText =
                    "Log in to continue your curation journey.";
            }
            if (switchText) switchText.innerText = "Don't have an account?";
            if (toggleBtn) toggleBtn.innerText = "Sign Up";
            if (passwordLabel) passwordLabel.innerText = "Password";
        }

        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerText = getSubmitText(mode);
        }

        clearAllFieldErrors();
        if (!options?.preserveMessage) clearMsg();
        updatePasswordHint(passwordInput?.value.length || 0);
    };

    const validateForm = (
        email: string,
        password: string,
        fullName: string,
        confirmPassword: string,
    ) => {
        clearAllFieldErrors();
        let isValid = true;

        if (authMode !== "reset") {
            if (!email) {
                setFieldError(emailInput, emailErrorEl, "Email is required.");
                isValid = false;
            } else if (!emailInput?.checkValidity()) {
                setFieldError(
                    emailInput,
                    emailErrorEl,
                    "Enter a valid email address (numbers are allowed).",
                );
                isValid = false;
            }
        }

        if (authMode !== "forgot") {
            if (password.length < 6) {
                setFieldError(
                    passwordInput,
                    passwordErrorEl,
                    "Password must be at least 6 characters.",
                );
                isValid = false;
            }
        }

        if (authMode === "signup") {
            const fullNamePattern = /^[A-Za-z][A-Za-z\s'-]*$/;

            if (!fullName) {
                setFieldError(
                    fullNameInput,
                    nameErrorEl,
                    "Full name is required.",
                );
                isValid = false;
            } else if (fullName.length < 2) {
                setFieldError(
                    fullNameInput,
                    nameErrorEl,
                    "Full name should be at least 2 characters.",
                );
                isValid = false;
            } else if (!fullNamePattern.test(fullName)) {
                setFieldError(
                    fullNameInput,
                    nameErrorEl,
                    "Use letters, spaces, apostrophes, or hyphens only.",
                );
                isValid = false;
            }
        }

        if (authMode === "reset" && password !== confirmPassword) {
            setFieldError(
                confirmPasswordInput,
                confirmPasswordErrorEl,
                "Passwords do not match.",
            );
            isValid = false;
        }

        updatePasswordHint(password.length);
        return isValid;
    };

    const getFriendlyAuthError = (error: any, mode: AuthMode) => {
        const message =
            error?.message || "Authentication failed. Please try again.";

        if (message.includes("Auth session missing")) {
            return "This reset link is expired or invalid. Request a new one.";
        }

        if (message.includes("Invalid login credentials")) {
            return mode === "signup"
                ? "This email is already in use or the password is invalid."
                : "Invalid email or password.";
        }

        if (message.includes("Password should be at least 6 characters")) {
            return "Password must be at least 6 characters.";
        }

        if (message.includes("User already registered")) {
            return "This email is already registered. Please log in instead.";
        }

        if (message.includes("Database error saving new user")) {
            return "Signup failed while creating your profile. Please try again.";
        }

        if (message.includes("security purposes")) {
            return "Please wait before requesting another reset email.";
        }

        return message;
    };

    const buildBaseUsername = (email: string) => {
        const localPart = email.split("@")[0] || "user";
        const cleaned = localPart
            .toLowerCase()
            .replace(/[^a-z0-9_]/g, "")
            .replace(/_+/g, "_")
            .replace(/^_+|_+$/g, "");

        const base = cleaned.length >= 3 ? cleaned : `${cleaned || "user"}user`;
        return base.slice(0, 24);
    };

    const createUsernameCandidate = (base: string) => {
        const suffix = Math.floor(1000 + Math.random() * 9000).toString();
        const prefixMax = Math.max(3, 24 - suffix.length);
        return `${base.slice(0, prefixMax)}${suffix}`;
    };

    const ensureUniqueUsername = async (email: string) => {
        const base = buildBaseUsername(email);
        if (!supabase) return createUsernameCandidate(base);

        let candidate = base;

        for (let i = 0; i < 10; i++) {
            const { data, error } = await supabase
                .from("profiles")
                .select("id")
                .eq("username", candidate)
                .limit(1);

            if (error) {
                // If read policy is tighter than expected, still avoid collisions probabilistically.
                return createUsernameCandidate(base);
            }

            if (!data || data.length === 0) {
                return candidate;
            }

            candidate = createUsernameCandidate(base);
        }

        return `${base.slice(0, 18)}${Date.now().toString().slice(-6)}`;
    };

    const toggleMode = (forceMode?: AuthMode) => {
        if (forceMode) {
            setMode(forceMode);
            return;
        }

        if (authMode === "signup") {
            setMode("login");
            return;
        }

        setMode("signup");
    };

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!supabase) {
            showMsg(
                "Authentication service is not available right now. Please try again.",
                "error",
            );
            return;
        }

        const email = emailInput?.value.trim() || "";
        const password = passwordInput?.value || "";
        const fullName = fullNameInput?.value.trim() || "";
        const confirmPassword = confirmPasswordInput?.value || "";

        if (!validateForm(email, password, fullName, confirmPassword)) {
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerText = getSubmitText(authMode, true);

        let result;

        try {
            const safeUsername =
                authMode === "signup"
                    ? await ensureUniqueUsername(email)
                    : undefined;

            if (authMode === "forgot") {
                const { error } = await supabase.auth.resetPasswordForEmail(
                    email,
                    {
                        redirectTo: `${window.location.origin}/login?mode=reset`,
                    },
                );
                if (error) throw error;

                showMsg(
                    "Reset email sent. Open your inbox and follow the secure link.",
                    "success",
                );
                submitBtn.disabled = false;
                submitBtn.innerText = getSubmitText("forgot");
                return;
            }

            if (authMode === "reset") {
                const { error } = await supabase.auth.updateUser({ password });
                if (error) throw error;

                showMsg("Password updated. Redirecting to login...", "success");
                submitBtn.innerText = "Saved";

                setTimeout(async () => {
                    await supabase.auth.signOut();
                    window.location.assign("/login");
                }, 1000);
                return;
            }

            if (authMode === "signup") {
                if (isLinking) {
                    // Upgrade Anonymous -> Real
                    result = await supabase.auth.updateUser({
                        email,
                        password,
                        data: { full_name: fullName, username: safeUsername },
                    });
                } else {
                    // New Signup
                    result = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                full_name: fullName,
                                username: safeUsername,
                            },
                        },
                    });
                }
            } else {
                // Log In
                result = await supabase.auth.signInWithPassword({
                    email,
                    password,
                });
            }

            const { data, error } = result;
            if (error) throw error;

            const hasSession = (data as any).session || isLinking;

            if (authMode === "signup" && !hasSession && !isLinking) {
                showMsg(
                    "Account created! Please check your email to confirm.",
                    "success",
                );
                submitBtn.innerText = "Check Email";
            } else {
                if (isLinking) {
                    // Manually ensure profile exists (upsert)
                    const { error: upsertError } = await supabase
                        .from("profiles")
                        .upsert({
                            id: (data.user as any)?.id,
                            username: safeUsername || buildBaseUsername(email),
                            full_name: fullName,
                            role: "user",
                        });

                    if (upsertError) {
                        console.error("Profile upsert failed:", upsertError);
                    }
                }

                showMsg("Success! Redirecting...", "success");

                // Smart redirect based on user role
                const { data: profile } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", (data.user as any)?.id)
                    .single();

                const params = new URLSearchParams(window.location.search);
                const redirect = params.get("redirect");

                if (redirect) {
                    window.location.assign(redirect);
                } else if (profile?.role === "admin") {
                    // Admins logging in via main login should probably go to Admin Dashboard,
                    // or Unified Dashboard? Let's send them to Unified for now as it has a link to Admin.
                    window.location.assign("/resources/dashboard");
                } else if (profile?.role === "curator") {
                    window.location.assign("/resources/dashboard");
                } else {
                    window.location.assign("/resources/dashboard");
                }
            }
        } catch (error: any) {
            const rawMessage = error?.message || "";
            if (
                rawMessage.includes("Password should be at least 6 characters")
            ) {
                setFieldError(
                    passwordInput,
                    passwordErrorEl,
                    "Password must be at least 6 characters.",
                );
            } else if (
                rawMessage.includes("User already registered") ||
                (authMode === "signup" &&
                    rawMessage.includes("Invalid login credentials"))
            ) {
                setFieldError(
                    emailInput,
                    emailErrorEl,
                    "This email is already registered. Please log in instead.",
                );
            } else if (
                authMode === "login" &&
                rawMessage.includes("Invalid login credentials")
            ) {
                setFieldError(
                    passwordInput,
                    passwordErrorEl,
                    "Wrong email or password. Please re-enter the password.",
                );
                // Also clear the password so they actually have to re-enter it
                passwordInput.value = "";
            }

            showMsg(getFriendlyAuthError(error, authMode), "error");
            submitBtn.disabled = false;
            submitBtn.innerText = getSubmitText(authMode);
        }
    });

    passwordToggleBtn?.addEventListener("click", () => {
        isPasswordVisible = !isPasswordVisible;
        syncPasswordVisibility();
    });

    fullNameInput?.addEventListener("input", () => {
        clearFieldError(fullNameInput, nameErrorEl);
        clearMsg();
    });

    emailInput?.addEventListener("input", () => {
        clearFieldError(emailInput, emailErrorEl);
        clearMsg();
    });

    passwordInput?.addEventListener("input", () => {
        clearFieldError(passwordInput, passwordErrorEl);
        updatePasswordHint(passwordInput.value.length);
        clearMsg();
    });

    confirmPasswordInput?.addEventListener("input", () => {
        clearFieldError(confirmPasswordInput, confirmPasswordErrorEl);
        clearMsg();
    });

    toggleBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        if (authMode === "forgot") {
            setMode("login");
            return;
        }

        toggleMode(authMode === "signup" ? "login" : "signup");
    });

    forgotPasswordBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        setMode("forgot");
    });

    // --- INIT ---
    const initPage = async () => {
        if (!supabase) return;

        setMode("login");
        syncPasswordVisibility();
        updatePasswordHint(passwordInput?.value.length || 0);

        supabase.auth.onAuthStateChange((event) => {
            if (event === "PASSWORD_RECOVERY") {
                setMode("reset", { preserveMessage: true });
                showMsg(
                    "Recovery verified. Enter your new password to continue.",
                    "success",
                );
            }
        });

        const params = new URLSearchParams(window.location.search);
        const mode = params.get("mode");
        const link = params.get("link");
        const hashParams = new URLSearchParams(window.location.hash.slice(1));
        const hashType = hashParams.get("type");

        const {
            data: { session },
        } = await supabase.auth.getSession();
        const isAnonymous = session?.user?.is_anonymous;

        if (link === "true" && isAnonymous) {
            isLinking = true;
            // console.log("Upgrading anonymous account...");
            toggleMode(true);
            if (pageTitle) pageTitle.innerText = "Save Your Progress";
            if (pageSubtitle)
                pageSubtitle.innerText =
                    "Create an account to save your bookmarks & upvotes forever.";
        } else if (mode === "reset" || hashType === "recovery") {
            setMode("reset");
        } else if (mode === "forgot") {
            setMode("forgot");
        } else if (mode === "signup") {
            setMode("signup");
        }
    };

    initPage();
</script>
