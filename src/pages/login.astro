---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../styles/resources.css";

const title = "Login | Resource Hub";
---

<BaseLayout title={title}>
    <div
        class="hub-container"
        style="max-width: 500px; padding-top: 80px; margin: 0 auto;"
    >
        <div
            class="hub-form"
            style="text-align: center; font-family: 'Poppins', sans-serif;"
        >
            <h1 class="hub-title" style="margin-bottom: 8px;" id="page-title">
                Curator Login
            </h1>
            <p
                style="color: var(--text-secondary); margin-bottom: 32px; font-size: 14px;"
                id="page-subtitle"
            >
                Log in to continue your curation journey.
            </p>

            <form id="auth-form" method="POST" style="text-align: left;">
                {/* Full Name - Hidden by default (Login Mode) */}
                <div
                    class="hub-form-group"
                    id="name-group"
                    style="display: none; margin-bottom: 24px;"
                >
                    <label class="hub-label" style="margin-bottom: 4px;"
                        >Full Name</label
                    >
                    <input
                        type="text"
                        id="fullname"
                        class="hub-input"
                        placeholder="Jane Doe"
                    />
                </div>

                <div class="hub-form-group" style="margin-bottom: 24px;">
                    <label class="hub-label" style="margin-bottom: 4px;"
                        >Email Address</label
                    >
                    <input
                        type="email"
                        id="email"
                        class="hub-input"
                        required
                        placeholder="you@example.com"
                    />
                </div>

                <div class="hub-form-group" style="margin-bottom: 24px;">
                    <label class="hub-label" style="margin-bottom: 4px;"
                        >Password</label
                    >
                    <input
                        type="password"
                        id="password"
                        class="hub-input"
                        required
                        placeholder="••••••••"
                        minlength="6"
                    />
                </div>

                <button
                    type="submit"
                    class="hub-btn"
                    id="submit-btn"
                    style="width: 100%; margin-top: 16px;"
                >
                    Log In
                </button>
            </form>

            <div
                id="message"
                style="margin-top: 24px; text-align: center; display: none; padding: 12px; border-radius: 8px; font-weight: 500; font-size: 14px;"
            >
            </div>

            <div
                style="margin-top: 32px; pt-4; border-top: 1px solid var(--border-subtle);"
            >
                <p style="font-size: 14px; color: var(--text-secondary);">
                    <span id="switch-text">Don't have an account?</span>
                    <button
                        id="mode-toggle"
                        style="background: none; border: none; color: var(--text-primary); font-weight: 600; cursor: pointer; text-decoration: underline; margin-left: 4px;"
                    >
                        Sign Up
                    </button>
                </p>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    import { supabase } from "../lib/supabaseClient";

    // --- STATE ---
    let captchaToken = ""; // Removed but needed for logic below? No, removing all logic.
    let isSignup = false;
    let isLinking = false;

    // --- ELEMENTS ---
    const form = document.getElementById("auth-form");
    const messageEl = document.getElementById("message");
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    const toggleBtn = document.getElementById("mode-toggle");
    const nameGroup = document.getElementById("name-group");
    const pageTitle = document.getElementById("page-title");
    const pageSubtitle = document.getElementById("page-subtitle");
    const switchText = document.getElementById("switch-text");
    const fullNameInput = document.getElementById(
        "fullname",
    ) as HTMLInputElement;

    // --- HELPERS ---
    const showMsg = (msg: string, type: "success" | "error") => {
        if (!messageEl) return;
        messageEl.style.display = "block";
        messageEl.innerText = msg;
        messageEl.style.background = type === "error" ? "#fee2e2" : "#dcfce7";
        messageEl.style.color = type === "error" ? "#b91c1c" : "#166534";
    };

    const toggleMode = (forceSignup?: boolean) => {
        if (forceSignup !== undefined) {
            isSignup = forceSignup;
        } else {
            isSignup = !isSignup;
        }

        if (isSignup) {
            nameGroup!.style.display = "block";
            if (!isLinking) {
                pageTitle!.innerText = "Join the Ecosystem";
                pageSubtitle!.innerText =
                    "Create an account to save and share resources.";
            }
            submitBtn!.innerText = "Create Account";
            switchText!.innerText = "Already have an account?";
            toggleBtn!.innerText = "Log In";
            fullNameInput?.setAttribute("required", "true");
        } else {
            nameGroup!.style.display = "none";
            pageTitle!.innerText = "Welcome Back";
            pageSubtitle!.innerText =
                "Log in to continue your curation journey.";
            submitBtn!.innerText = "Log In";
            switchText!.innerText = "Don't have an account?";
            toggleBtn!.innerText = "Sign Up";
            fullNameInput?.removeAttribute("required");
        }

        if (messageEl) messageEl.style.display = "none";
    };

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!supabase) return;

        submitBtn.disabled = true;
        submitBtn.innerText = isSignup ? "Creating..." : "Logging in...";

        const email = (document.getElementById("email") as HTMLInputElement)
            .value;
        const password = (
            document.getElementById("password") as HTMLInputElement
        ).value;
        const fullName = fullNameInput.value;
        let result;

        try {
            if (isSignup) {
                if (isLinking) {
                    // Upgrade Anonymous -> Real
                    result = await supabase.auth.updateUser({
                        email,
                        password,
                        data: { full_name: fullName },
                    });
                } else {
                    // New Signup
                    result = await supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: { full_name: fullName },
                        },
                    });
                }
            } else {
                // Log In
                result = await supabase.auth.signInWithPassword({
                    email,
                    password,
                });
            }

            const { data, error } = result;
            if (error) throw error;

            const hasSession = (data as any).session || isLinking;

            if (isSignup && !hasSession && !isLinking) {
                showMsg(
                    "Account created! Please check your email to confirm.",
                    "success",
                );
                submitBtn.innerText = "Check Email";
            } else {
                if (isLinking) {
                    // Manually ensure profile exists (upsert)
                    await supabase.from("profiles").upsert({
                        id: (data.user as any)?.id,
                        username: email.split("@")[0],
                        full_name: fullName,
                        role: "user",
                    });
                }

                showMsg("Success! Redirecting...", "success");

                // Smart redirect based on user role
                const { data: profile } = await supabase
                    .from("profiles")
                    .select("role")
                    .eq("id", (data.user as any)?.id)
                    .single();

                const params = new URLSearchParams(window.location.search);
                const redirect = params.get("redirect");

                if (redirect) {
                    window.location.assign(redirect);
                } else if (profile?.role === "admin") {
                    // Admins logging in via main login should probably go to Admin Dashboard,
                    // or Unified Dashboard? Let's send them to Unified for now as it has a link to Admin.
                    window.location.assign("/resources/dashboard");
                } else if (profile?.role === "curator") {
                    window.location.assign("/resources/dashboard");
                } else {
                    window.location.assign("/resources/dashboard");
                }
            }
        } catch (error: any) {
            if (error.message.includes("Invalid login credentials")) {
                showMsg(
                    isSignup
                        ? "Error: This email might already be in use."
                        : "Invalid email or password.",
                    "error",
                );
            } else {
                showMsg(error.message, "error");
            }
            submitBtn.disabled = false;
            submitBtn.innerText = isSignup ? "Create Account" : "Log In";
            submitBtn.disabled = false;
            submitBtn.innerText = isSignup ? "Create Account" : "Log In";
        }
    });

    toggleBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        toggleMode();
    });

    // --- INIT ---
    const initPage = async () => {
        if (!supabase) return;

        const params = new URLSearchParams(window.location.search);
        const mode = params.get("mode");
        const link = params.get("link");

        const {
            data: { session },
        } = await supabase.auth.getSession();
        const isAnonymous = session?.user?.is_anonymous;

        if (link === "true" && isAnonymous) {
            isLinking = true;
            console.log("Upgrading anonymous account...");
            toggleMode(true);
            if (pageTitle) pageTitle.innerText = "Save Your Progress";
            if (pageSubtitle)
                pageSubtitle.innerText =
                    "Create an account to save your bookmarks & upvotes forever.";
        } else if (mode === "signup") {
            toggleMode(true);
        }
    };

    initPage();
</script>
