---
import BaseLayout from "../layouts/BaseLayout.astro";

const pageTitle = "The Secret Lab";
---

<BaseLayout title={pageTitle}>
    <div class="secret-lab-container">
        <div class="content-wrapper">
            {/* Left Column - Secret Lab Info */}
            <div class="lab-section">
                <div class="section-header">
                    <span class="overline">Classified</span>
                    <h1>The Secret Lab</h1>
                </div>

                <div class="lab-manifesto">
                    <p class="lead">
                        The tags you discovered are the building blocks of my
                        <span class="highlight">digital consciousness</span>.
                        Everything my life revolves around—from art and design
                        to philosophy and deep tech—lives here.
                    </p>
                    <p>
                        This is not just a blog. It is a
                        <span class="highlight">living knowledge graph</span>. A
                        huge bank of interconnected notes, journals, and raw
                        ideas.
                    </p>
                </div>

                <div class="access-panel">
                    <p class="access-label">Authorization Required</p>
                    <div class="password-display" id="password-container">
                        <span class="password-label">Passkey:</span>
                        <span class="code hidden-mode" id="password-text"
                            >Click to reveal</span
                        >
                    </div>
                    <button id="copy-password" class="copy-btn hidden">
                        Copy Password
                    </button>
                    <div id="copy-feedback" class="copy-feedback"></div>

                    <a href="/research/obsidian-vault" class="enter-btn">
                        Enter Second Brain →
                    </a>
                </div>
            </div>

            {/* Right Column - Club Signup */}
            <div class="club-section">
                <div class="section-header">
                    <span class="overline">Private Access</span>
                    <h2>Join the Second Brain Club</h2>
                </div>

                <div class="club-content">
                    <p>
                        A private knowledge space for researchers, creatives,
                        and thinkers building long-term intellectual leverage.
                    </p>

                    <div class="target-audience">
                        <h3>Who This Is For</h3>
                        <ul>
                            <li>PhD & Master's Students</li>
                            <li>Researchers & Academics</li>
                            <li>Knowledge Workers & Creatives</li>
                        </ul>
                        <p class="student-offer">
                            Special offers available for students and
                            early-career researchers.
                        </p>
                    </div>

                    <form id="club-signup-form" class="signup-form">
                        <div class="form-group">
                            <input
                                type="text"
                                name="first_name"
                                placeholder="First name"
                                required
                            />
                        </div>
                        <div class="form-group">
                            <input
                                type="email"
                                name="email"
                                placeholder="Email address"
                                required
                            />
                        </div>
                        <button type="submit" class="submit-btn">
                            Request Access
                        </button>
                    </form>

                    <div id="signup-message" class="signup-message"></div>

                    <p class="microcopy">
                        Private access. Thoughtfully curated. No spam.
                    </p>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    // --- PASSWORD REVEAL LOGIC ---
    const passwordContainer = document.getElementById("password-container");
    const passwordText = document.getElementById("password-text");
    const realPassword = "mysecondbrain@2026";
    const chars =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%^&*";
    let isRevealed = false;

    if (passwordContainer && passwordText) {
        passwordContainer.addEventListener("click", () => {
            if (isRevealed) return;
            isRevealed = true;
            passwordText.classList.remove("hidden-mode");
            passwordText.style.color = "#0f0"; // Ensure green color

            let iterations = 0;
            const maxIterations = 20; // How many shuffles before settling
            const interval = setInterval(() => {
                passwordText.innerText = realPassword
                    .split("")
                    .map((char, index) => {
                        if (index < iterations) {
                            return realPassword[index];
                        }
                        return chars[Math.floor(Math.random() * chars.length)];
                    })
                    .join("");

                if (iterations >= realPassword.length) {
                    clearInterval(interval);
                    passwordText.innerText = realPassword; // Ensure final State

                    // Show copy button after password is revealed
                    const copyBtn = document.getElementById("copy-password");
                    if (copyBtn) {
                        copyBtn.classList.remove("hidden");
                    }
                }

                // Incremental reveal
                iterations += 1 / 3;
            }, 50);
        });
    }

    // --- COPY PASSWORD LOGIC ---
    const copyBtn = document.getElementById("copy-password");
    const copyFeedback = document.getElementById("copy-feedback");

    if (copyBtn) {
        copyBtn.addEventListener("click", async () => {
            try {
                await navigator.clipboard.writeText(realPassword);

                // Show success feedback
                if (copyFeedback) {
                    copyFeedback.innerText = "✓ Copied to clipboard";
                    copyFeedback.className = "copy-feedback success";

                    // Hide feedback after 2 seconds
                    setTimeout(() => {
                        copyFeedback.className = "copy-feedback";
                        copyFeedback.innerText = "";
                    }, 2000);
                }
            } catch (err) {
                console.error("Copy failed:", err);
                if (copyFeedback) {
                    copyFeedback.innerText = "✗ Copy failed";
                    copyFeedback.className = "copy-feedback error";

                    setTimeout(() => {
                        copyFeedback.className = "copy-feedback";
                        copyFeedback.innerText = "";
                    }, 2000);
                }
            }
        });
    }

    // --- CLUB SIGNUP LOGIC ---
    const signupForm = document.getElementById(
        "club-signup-form",
    ) as HTMLFormElement | null;
    const signupMessage = document.getElementById("signup-message");

    if (signupForm) {
        signupForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(signupForm);
            const data = Object.fromEntries(formData.entries());

            if (signupMessage) {
                signupMessage.innerText = "ESTABLISHING UPLINK...";
                signupMessage.className = "signup-message processing";
            }

            try {
                const response = await fetch("/api/join-club", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    if (signupMessage) {
                        signupMessage.innerText =
                            "ACCESS GRANTED. REDIRECTING...";
                        signupMessage.className = "signup-message success";
                    }
                    // Redirect to Welcome Page
                    setTimeout(() => {
                        window.location.href = "/club/welcome";
                    }, 1000);
                } else {
                    throw new Error(result.error || "Failed to join");
                }
            } catch (err: any) {
                console.error(err);
                if (signupMessage) {
                    signupMessage.innerText = `ERROR: ${err.message?.toUpperCase() || "UNKNOWN ERROR"}`;
                    signupMessage.className = "signup-message error";
                }
            }
        });
    }
</script>

<style>
    /* --- CONTAINER --- */
    .secret-lab-container {
        width: 100%;
        min-height: 70vh;
        padding: var(--space-xl) 0;
    }

    .content-wrapper {
        max-width: var(--max-width);
        margin: 0 auto;
        padding: 0 24px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-2xl);
        align-items: start;
    }

    @media (max-width: 900px) {
        .content-wrapper {
            grid-template-columns: 1fr;
            gap: var(--space-xl);
        }
    }

    /* --- SECTION STYLES --- */
    .lab-section,
    .club-section {
        display: flex;
        flex-direction: column;
        gap: var(--space-lg);
    }

    .section-header {
        border-bottom: 1px solid var(--border-subtle);
        padding-bottom: var(--space-md);
    }

    .overline {
        display: block;
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--text-secondary);
        margin-bottom: var(--space-sm);
        font-weight: 500;
    }

    h1 {
        font-family: "Poppins", sans-serif;
        font-size: var(--text-3xl);
        font-weight: 700;
        margin: 0;
        color: var(--text-primary);
        letter-spacing: -0.02em;
        line-height: 1.1;
    }

    h2 {
        font-family: "Poppins", sans-serif;
        font-size: var(--text-2xl);
        font-weight: 600;
        margin: 0;
        color: var(--text-primary);
        letter-spacing: -0.02em;
        line-height: 1.1;
    }

    /* --- MANIFESTO --- */
    .lab-manifesto {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }

    .lab-manifesto .lead {
        font-size: var(--text-lg);
        line-height: 1.6;
        color: var(--text-primary);
    }

    .lab-manifesto p {
        font-size: var(--text-base);
        line-height: 1.7;
        color: var(--text-secondary);
        margin: 0;
    }

    .highlight {
        color: var(--text-primary);
        font-weight: 600;
        position: relative;
    }

    /* --- ACCESS PANEL --- */
    .access-panel {
        border: 1px solid var(--border-subtle);
        border-radius: 4px;
        padding: var(--space-lg);
        background: var(--bg-surface);
        transition: border-color 0.3s ease;
    }

    .access-panel:hover {
        border-color: var(--border-strong);
    }

    .access-label {
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-secondary);
        margin: 0 0 var(--space-md) 0;
        font-weight: 600;
    }

    /* --- PASSWORD DISPLAY --- */
    .password-display {
        font-family: "Space Mono", monospace;
        font-size: var(--text-sm);
        background: var(--bg-color);
        border: 1px solid var(--border-subtle);
        padding: var(--space-md);
        margin-bottom: var(--space-md);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .password-display:hover {
        border-color: #00ff41;
        box-shadow: 0 0 8px rgba(0, 255, 65, 0.15);
    }

    .password-label {
        color: var(--text-tertiary);
        font-size: var(--text-xs);
        font-weight: bold;
    }

    .code {
        color: #00ff41;
        font-weight: 600;
        letter-spacing: 0.05em;
    }

    .code.hidden-mode {
        color: var(--text-tertiary);
        filter: blur(3px);
        user-select: none;
        transition: all 0.3s;
    }

    /* --- COPY BUTTON --- */
    .copy-btn {
        width: 100%;
        padding: var(--space-sm);
        background: transparent;
        border: 1px solid #00ff41;
        color: #00ff41;
        border-radius: 4px;
        font-family: "Space Mono", monospace;
        font-size: var(--text-xs);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: var(--space-sm);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .copy-btn:hover {
        background: rgba(0, 255, 65, 0.1);
        transform: translateY(-1px);
    }

    .copy-btn.hidden {
        display: none;
    }

    /* --- COPY FEEDBACK --- */
    .copy-feedback {
        min-height: 1.2em;
        font-size: var(--text-xs);
        font-family: "Space Mono", monospace;
        text-align: center;
        margin-bottom: var(--space-sm);
        font-weight: 600;
    }

    .copy-feedback.success {
        color: #00ff41;
    }

    .copy-feedback.error {
        color: #ff4444;
    }

    /* --- ENTER BUTTON --- */
    .enter-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: var(--space-md);
        background: var(--accent);
        color: var(--bg-color);
        text-decoration: none;
        font-weight: 600;
        font-size: var(--text-sm);
        border-radius: 4px;
        transition: all 0.2s ease;
        border: 1px solid var(--accent);
    }

    .enter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .enter-btn:hover {
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    }

    /* --- CLUB CONTENT --- */
    .club-content {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
    }

    .club-content p {
        font-size: var(--text-base);
        line-height: 1.7;
        color: var(--text-secondary);
        margin: 0;
    }

    /* --- TARGET AUDIENCE --- */
    .target-audience {
        margin-top: var(--space-md);
        padding: var(--space-md);
        background: var(--bg-surface);
        border-radius: 4px;
        border: 1px solid var(--border-subtle);
    }

    .target-audience h3 {
        font-size: var(--text-sm);
        font-weight: 600;
        margin: 0 0 var(--space-sm) 0;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .target-audience ul {
        list-style: none;
        padding: 0;
        margin: 0 0 var(--space-md) 0;
    }

    .target-audience li {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-bottom: var(--space-sm);
        padding-left: 1rem;
        position: relative;
    }

    .target-audience li::before {
        content: "→";
        position: absolute;
        left: 0;
        color: #00ff41;
    }

    .student-offer {
        font-size: var(--text-xs);
        color: #00ff41;
        font-weight: 600;
        margin: 0;
        padding-top: var(--space-sm);
        border-top: 1px solid var(--border-subtle);
    }

    /* --- SIGNUP FORM --- */
    .signup-form {
        display: flex;
        flex-direction: column;
        gap: var(--space-md);
        margin-top: var(--space-sm);
    }

    .form-group {
        width: 100%;
    }

    .form-group input {
        width: 100%;
        padding: var(--space-md);
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 4px;
        font-family: "Inter", sans-serif;
        font-size: var(--text-sm);
        color: var(--text-primary);
        outline: none;
        transition: all 0.3s ease;
        box-sizing: border-box;
    }

    .form-group input::placeholder {
        color: var(--text-tertiary);
    }

    .form-group input:focus {
        border-color: #00ff41;
        box-shadow: 0 0 0 3px rgba(0, 255, 65, 0.1);
        background: var(--bg-color);
    }

    /* --- SUBMIT BUTTON --- */
    .submit-btn {
        width: 100%;
        padding: var(--space-md);
        background: var(--accent);
        color: var(--bg-color);
        border: 1px solid var(--accent);
        border-radius: 4px;
        font-family: "Poppins", sans-serif;
        font-weight: 600;
        font-size: var(--text-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: none;
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    [data-theme="dark"] .submit-btn:hover {
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
    }

    .submit-btn:active {
        transform: translateY(0);
    }

    /* --- SIGNUP MESSAGE --- */
    .signup-message {
        min-height: 1.5em;
        font-size: var(--text-sm);
        font-weight: 600;
        text-align: center;
        font-family: "Space Mono", monospace;
    }

    .signup-message.processing {
        color: var(--text-secondary);
    }

    .signup-message.success {
        color: #00ff41;
    }

    .signup-message.error {
        color: #ff4444;
    }

    /* --- MICROCOPY --- */
    .microcopy {
        font-size: var(--text-xs);
        color: var(--text-tertiary);
        text-align: center;
        margin: 0;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 768px) {
        h1 {
            font-size: var(--text-2xl);
        }

        h2 {
            font-size: var(--text-xl);
        }

        .lab-manifesto .lead {
            font-size: var(--text-base);
        }
    }
</style>
