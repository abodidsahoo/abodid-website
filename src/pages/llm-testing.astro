---
import BaseLayout from "../layouts/BaseLayout.astro";
import "../styles/resources.css";

const title = "LLM Lab | Vision Test";
---

<BaseLayout title={title}>
    <div class="lab-container">
        <header class="lab-header">
            <h1>LLM Vision Lab</h1>
            <p>Testing ground for Image Analysis & Chat.</p>
        </header>

        <div class="lab-grid">
            <!-- Left: Chat Interface -->
            <div class="chat-interface">
                <div id="chat-history" class="chat-history">
                    <div class="system-message">
                        System ready. Supports Image Upload.
                    </div>
                </div>

                <!-- Image Preview Area -->
                <div
                    id="image-preview-area"
                    class="image-preview-area"
                    style="display: none;"
                >
                    <div class="preview-card">
                        <img id="preview-img" src="" alt="Upload preview" />
                        <button id="remove-img-btn" class="remove-btn">×</button
                        >
                    </div>
                </div>

                <form id="chat-form" class="chat-form">
                    <div class="input-actions">
                        <label
                            for="image-upload"
                            class="icon-btn"
                            title="Upload Image"
                        >
                            <svg
                                width="20"
                                height="20"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                ><rect
                                    x="3"
                                    y="3"
                                    width="18"
                                    height="18"
                                    rx="2"
                                    ry="2"></rect><circle
                                    cx="8.5"
                                    cy="8.5"
                                    r="1.5"></circle><polyline
                                    points="21 15 16 10 5 21"></polyline></svg
                            >
                        </label>
                        <input
                            type="file"
                            id="image-upload"
                            accept="image/*"
                            style="display: none;"
                        />
                    </div>

                    <input
                        type="text"
                        id="user-input"
                        placeholder="Ask something about an image..."
                        required
                        autocomplete="off"
                    />
                    <button type="submit" id="send-btn">
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><line x1="22" y1="2" x2="11" y2="13"
                            ></line><polygon points="22 2 15 22 11 13 2 9 22 2"
                            ></polygon></svg
                        >
                    </button>
                </form>
            </div>

            <!-- Right: Process Log -->
            <div class="process-log-panel">
                <div class="log-header">
                    <span class="log-icon">⚡</span>
                    <span class="log-title">System Process</span>
                </div>
                <div id="process-log-content" class="log-content">
                    <div class="log-entry">Waiting for input...</div>
                </div>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    interface ChatMessage {
        role: "user" | "assistant" | "system";
        content:
            | string
            | Array<{
                  type: string;
                  text?: string;
                  image_url?: { url: string };
              }>;
    }

    const chatHistory = document.getElementById(
        "chat-history",
    ) as HTMLDivElement;
    const chatForm = document.getElementById("chat-form") as HTMLFormElement;
    const userInput = document.getElementById("user-input") as HTMLInputElement;
    const sendBtn = document.getElementById("send-btn") as HTMLButtonElement;
    const logContent = document.getElementById(
        "process-log-content",
    ) as HTMLDivElement;

    // Image Upload Elements
    const imageUpload = document.getElementById(
        "image-upload",
    ) as HTMLInputElement;
    const imagePreviewArea = document.getElementById(
        "image-preview-area",
    ) as HTMLDivElement;
    const previewImg = document.getElementById(
        "preview-img",
    ) as HTMLImageElement;
    const removeImgBtn = document.getElementById(
        "remove-img-btn",
    ) as HTMLButtonElement;

    let messages: ChatMessage[] = [];
    let currentImageBase64: string | null = null;

    // --- Image Handling ---
    if (imageUpload) {
        imageUpload.addEventListener("change", (e) => {
            const file = (e.target as HTMLInputElement).files?.[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                if (typeof reader.result === "string") {
                    currentImageBase64 = reader.result;
                    if (previewImg) previewImg.src = currentImageBase64;
                    if (imagePreviewArea)
                        imagePreviewArea.style.display = "flex";
                    if (userInput) userInput.focus();
                }
            };
            reader.readAsDataURL(file);
        });
    }

    if (removeImgBtn) {
        removeImgBtn.addEventListener("click", () => {
            currentImageBase64 = null;
            if (imageUpload) imageUpload.value = "";
            if (imagePreviewArea) imagePreviewArea.style.display = "none";
        });
    }

    // --- Chat Logic ---

    function appendMessage(
        role: string,
        text: string | null,
        model: string | null = null,
        imageUrl: string | null = null,
    ) {
        if (!chatHistory) return;

        const div = document.createElement("div");
        div.className = `message ${role}`;

        // Image in Message
        if (imageUrl) {
            const img = document.createElement("img");
            img.src = imageUrl;
            img.className = "message-image";
            div.appendChild(img);
        }

        // Text Content
        if (text) {
            const contentDiv = document.createElement("div");
            contentDiv.className = "message-content";
            contentDiv.innerText = text;
            div.appendChild(contentDiv);
        }

        // Model Badge
        if (role === "assistant" && model) {
            const badge = document.createElement("div");
            badge.className = "model-badge";
            badge.innerText = `Used: ${model.split("/")[1] || model}`;
            div.appendChild(badge);
        }

        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function addLog(msg: string) {
        if (!logContent) return;
        const div = document.createElement("div");
        div.className = "log-entry";
        div.innerText = msg;
        logContent.appendChild(div);
        logContent.scrollTop = logContent.scrollHeight;
    }

    function clearLogs() {
        if (logContent) logContent.innerHTML = "";
    }

    if (chatForm) {
        chatForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (!userInput) return;

            const text = userInput.value.trim();
            if (!text && !currentImageBase64) return;

            // Prepare message object
            const newMessage: ChatMessage = {
                role: "user",
                content: [],
            };

            const contentArray = newMessage.content as Array<any>;

            if (text) {
                contentArray.push({ type: "text", text: text });
            }

            if (currentImageBase64) {
                contentArray.push({
                    type: "image_url",
                    image_url: { url: currentImageBase64 },
                });
            }

            // Update UI
            appendMessage("user", text, null, currentImageBase64);

            // Reset Inputs
            userInput.value = "";
            const tempImage = currentImageBase64; // Keep ref for sending
            currentImageBase64 = null;
            if (imageUpload) imageUpload.value = "";
            if (imagePreviewArea) imagePreviewArea.style.display = "none";

            userInput.disabled = true;
            if (sendBtn) {
                sendBtn.disabled = true;
                // Preserve the SVG icon
                const originalBtnContent = sendBtn.innerHTML;
            }

            clearLogs();
            if (tempImage) addLog("Image detected. Optimizing vision model...");
            addLog("Sending request...");

            // Add to history
            messages.push(newMessage);

            try {
                const response = await fetch("/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ messages }),
                });

                const data = await response.json();

                // Logs
                if (data.logs && Array.isArray(data.logs)) {
                    data.logs.forEach((logMsg: string) => addLog(logMsg));
                }

                if (!response.ok) {
                    throw new Error(data.error || "Failed");
                }

                appendMessage("assistant", data.message, data.metadata?.model);
                messages.push({ role: "assistant", content: data.message });
            } catch (error) {
                const errorMessage =
                    error instanceof Error ? error.message : String(error);
                addLog(`Error: ${errorMessage}`);
                appendMessage("error", `Error: ${errorMessage}`);
            } finally {
                userInput.disabled = false;
                if (sendBtn) sendBtn.disabled = false;
                userInput.focus();
            }
        });
    }
</script>

<style>
    /* ... Reusing previous styles with additions ... */
    .lab-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 120px 24px 64px;
        font-family: var(--font-ui);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .lab-header {
        margin-bottom: 40px;
        text-align: center;
    }
    .lab-header h1 {
        font-family: var(--font-display);
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
    }
    .lab-header p {
        color: var(--text-secondary);
    }

    .lab-grid {
        display: grid;
        grid-template-columns: 1fr 280px;
        gap: 24px;
        align-items: start;
    }
    @media (max-width: 768px) {
        .lab-grid {
            grid-template-columns: 1fr;
        }
    }

    .chat-interface {
        display: flex;
        flex-direction: column;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        overflow: hidden;
        height: 650px;
    }

    .chat-history {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .message {
        max-width: 85%;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .message-content {
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    .message.user {
        align-self: flex-end;
        align-items: flex-end;
    }
    .message.user .message-content {
        background: var(--text-primary);
        color: var(--bg-color);
    }
    .message.assistant {
        align-self: flex-start;
        align-items: flex-start;
    }
    .message.assistant .message-content {
        background: var(--bg-surface-hover);
        color: var(--text-primary);
        border: 1px solid var(--border-subtle);
    }
    .message.error {
        align-self: center;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
    }

    .message-image {
        max-width: 200px;
        border-radius: 8px;
        margin-bottom: 4px;
        border: 1px solid var(--border-subtle);
    }

    .model-badge {
        font-size: 0.7rem;
        color: var(--text-tertiary);
        margin-left: 4px;
        font-family: var(--font-mono);
    }
    .system-message {
        text-align: center;
        color: var(--text-tertiary);
        font-size: 0.85rem;
        margin-bottom: 16px;
        font-family: var(--font-mono);
    }

    /* Input Area */
    .chat-form {
        padding: 16px;
        background: var(--bg-surface);
        border-top: 1px solid var(--border-subtle);
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .input-actions {
        display: flex;
        align-items: center;
    }
    .icon-btn {
        padding: 8px;
        cursor: pointer;
        color: var(--text-secondary);
        border-radius: 6px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .icon-btn:hover {
        background: var(--bg-surface-hover);
        color: var(--text-primary);
    }

    .image-preview-area {
        padding: 0 16px 12px;
        background: var(--bg-surface);
    }
    .preview-card {
        position: relative;
        display: inline-block;
    }
    .preview-card img {
        height: 60px;
        border-radius: 6px;
        border: 1px solid var(--border-subtle);
    }
    .remove-btn {
        position: absolute;
        top: -6px;
        right: -6px;
        width: 18px;
        height: 18px;
        background: var(--text-primary);
        color: var(--bg-color);
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
    }

    input[type="text"] {
        flex: 1;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid var(--border-subtle);
        background: var(--bg-color);
        color: var(--text-primary);
        font-family: inherit;
        font-size: 1rem;
        outline: none;
    }
    input:focus {
        border-color: var(--text-primary);
    }

    button[type="submit"] {
        padding: 0 16px;
        height: 44px;
        background: var(--text-primary);
        color: var(--bg-color);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    button:disabled {
        opacity: 0.7;
        cursor: wait;
    }

    /* Log Panel */
    .process-log-panel {
        background: #0d1117;
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        overflow: hidden;
        height: 650px;
        display: flex;
        flex-direction: column;
    }
    .log-header {
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .log-icon {
        font-size: 1rem;
    }
    .log-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .log-content {
        flex: 1;
        padding: 16px;
        overflow-y: auto;
        font-family: var(--font-mono);
        font-size: 0.8rem;
        color: #8b949e;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    .log-entry {
        line-height: 1.4;
        animation: fadeIn 0.2s ease;
    }
    .log-entry:last-child {
        color: #58a6ff;
    }
</style>
