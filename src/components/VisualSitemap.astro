---
import FlowchartSitemap from "./FlowchartSitemap.jsx";
import {
    getAllPosts,
    getAllPhotography,
    getResearchPapers,
    getFilms,
} from "../lib/api";
import { getApprovedResources } from "../lib/resources/db";

// Fetch Content
const allPosts = await getAllPosts();
const allPhotography = await getAllPhotography();
const allPapers = await getResearchPapers();
const allFilms = await getFilms();
const allResources = await getApprovedResources({});

// Helper to limit items and shorten names
const limitItems = (items, limit, parentHref) => {
    if (!items || items.length === 0) return [];

    // Sort by date or importance if needed (assuming implicit order is good)
    const visible = items.slice(0, limit).map((item) => ({
        name: item.title
            ? item.title.split(" ").slice(0, 4).join(" ") +
              (item.title.split(" ").length > 4 ? "..." : "")
            : item.name,
        href:
            item.href ||
            (item.slug ? `${parentHref}/${item.slug}` : parentHref),
        desc: item.desc || "Item",
    }));

    if (items.length > limit) {
        visible.push({
            name: `... [${items.length} total]`,
            href: parentHref,
            isMeta: true, // Special styling for count
            desc: "View all",
        });
    }
    return visible;
};

// Construct the Hierarchy (Flattened)
const mapData = {
    name: "Abodid.com",
    href: "/",
    desc: "Index",
    // Level 1: Main Pages
    children: [
        { name: "About", href: "/about", desc: "The person" },
        { name: "Timeline", href: "/timeline", desc: "History" },
        {
            name: "Photography",
            href: "/photography",
            desc: "Visual Stories",
            children: [
                {
                    name: "Photography Portfolio",
                    href: "/photography-portfolio",
                    desc: "Floating Archive",
                },
                ...limitItems(allPhotography, 5, "/photography"),
            ],
        },
        {
            name: "Research",
            href: "/research",
            desc: "Studies",
            children: [
                {
                    name: "Major Papers",
                    children: limitItems(allPapers, 5, "/research"),
                },
                {
                    name: "Invisible Punctum",
                    href: "/research/invisible-punctum",
                    desc: "Major Study",
                },
                {
                    name: "Obsidian Vault",
                    href: "/research/obsidian-vault",
                    desc: "Digital Brain",
                },
                {
                    name: "LLM Chatbot",
                    href: "/research/llm-chatbot",
                    desc: "AI Experiment",
                },
                {
                    name: "Polaroid Hub",
                    href: "/research/polaroid-hub",
                    desc: "Analog",
                },
            ],
        },
        {
            name: "Blog",
            href: "/blog",
            desc: "Writings",
            children: limitItems(allPosts, 5, "/blog"),
        },
        {
            name: "Films",
            href: "/films",
            desc: "Cinema",
            children: limitItems(allFilms, 5, "/films"),
        },

        {
            name: "Resources",
            href: "/resources",
            desc: "Library",
            children: limitItems(allResources, 5, "/resources"),
        },
        { name: "Club", href: "/club/welcome", desc: "Join" },
        { name: "Services", href: "/services", desc: "Work" },
        { name: "Contact", href: "/contact", desc: "Email" },
    ],
};
---

<div class="sitemap-wrapper">
    <FlowchartSitemap client:load data={mapData} />
</div>

<style>
    .sitemap-wrapper {
        width: 100vw;
        margin-left: calc(-50vw + 50%); /* Break out */
        /* background: #050505; Removed to use default bg */
        min-height: 100vh;
        /* Custom scrollbar for this container if needed */
    }
</style>
