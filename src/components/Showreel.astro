---
const videoUrl =
    "https://jwipqbjxpmgyevfzpjjx.supabase.co/storage/v1/object/public/films/videos/Showreel%202025%20compressed.mp4";
---

<div class="showreel-container" style="display: none;">
    <video
        id="showreel-video"
        class="showreel-video"
        loop
        muted
        playsinline
        webkit-playsinline
        preload="auto"
        autoplay
    >
        <!-- Source will be added via JS with proper type -->
    </video>

    <!-- Video Controls -->
    <div class="video-controls">
        <!-- Fullscreen Button -->
        <button
            id="fullscreen-btn"
            class="control-btn"
            title="Toggle Fullscreen"
        >
            <!-- Enter Fullscreen Icon (Default) -->
            <svg id="icon-enter-fullscreen" viewBox="0 0 24 24">
                <path
                    d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"
                ></path>
            </svg>
            <!-- Exit Fullscreen Icon -->
            <svg
                id="icon-exit-fullscreen"
                viewBox="0 0 24 24"
                style="display: none;"
            >
                <path
                    d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"
                ></path>
            </svg>
        </button>

        <!-- Mute/Unmute Button -->
        <button id="mute-btn" class="control-btn" title="Toggle Sound">
            <!-- Muted Icon (Default) -->
            <svg id="icon-muted" viewBox="0 0 24 24">
                <path
                    d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73 4.27 3zM12 4L9.91 6.09 12 8.18V4z"
                ></path>
            </svg>
            <!-- Unmuted Icon -->
            <svg id="icon-unmuted" viewBox="0 0 24 24" style="display: none;">
                <path
                    d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"
                ></path>
            </svg>
        </button>
    </div>
</div>

<!-- Credits Section (Separate from video) -->
<div class="showreel-credits">
    <p class="credits-roles">
        <span class="role-label">ROLE:</span> Director / Editor / Sound Designer /
        Cinematographer / Colourist / Creative Producer
    </p>
    <a href="/films" class="view-all-btn">VIEW ALL FILMS</a>
</div>

<script define:vars={{ videoUrl }}>
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.querySelector(".showreel-container");
        const video = document.getElementById("showreel-video");
        const muteBtn = document.getElementById("mute-btn");
        const iconMuted = document.getElementById("icon-muted");
        const iconUnmuted = document.getElementById("icon-unmuted");
        const fullscreenBtn = document.getElementById("fullscreen-btn");
        const iconEnterFullscreen = document.getElementById(
            "icon-enter-fullscreen",
        );
        const iconExitFullscreen = document.getElementById(
            "icon-exit-fullscreen",
        );

        if (!container || !video) return;

        // Toggle Mute Logic
        if (muteBtn) {
            muteBtn.addEventListener("click", () => {
                video.muted = !video.muted;
                if (video.muted) {
                    iconMuted.style.display = "block";
                    iconUnmuted.style.display = "none";
                } else {
                    iconMuted.style.display = "none";
                    iconUnmuted.style.display = "block";
                }
            });
        }

        // Toggle Fullscreen Logic
        if (fullscreenBtn) {
            fullscreenBtn.addEventListener("click", () => {
                if (!document.fullscreenElement) {
                    // Enter fullscreen
                    container
                        .requestFullscreen()
                        .then(() => {
                            iconEnterFullscreen.style.display = "none";
                            iconExitFullscreen.style.display = "block";
                        })
                        .catch((err) => {
                            console.error("Error entering fullscreen:", err);
                        });
                } else {
                    // Exit fullscreen
                    document
                        .exitFullscreen()
                        .then(() => {
                            iconEnterFullscreen.style.display = "block";
                            iconExitFullscreen.style.display = "none";
                        })
                        .catch((err) => {
                            console.error("Error exiting fullscreen:", err);
                        });
                }
            });

            // Listen for fullscreen changes (e.g., ESC key)
            document.addEventListener("fullscreenchange", () => {
                if (!document.fullscreenElement) {
                    iconEnterFullscreen.style.display = "block";
                    iconExitFullscreen.style.display = "none";
                }
            });
        }

        // Safari-compatible loading strategy with smooth expansion
        const loadShowreel = () => {
            if (!video.src) {
                // Set video source
                video.src = videoUrl;
                video.load();

                // ULTRA-AGGRESSIVE AUTOPLAY STRATEGY
                let playAttempts = 0;
                const maxAttempts = 30;
                let hasStartedPlaying = false;
                let playbackMonitor = null;

                // Continuous play forcing
                const forcePlay = () => {
                    if (hasStartedPlaying || playAttempts >= maxAttempts)
                        return;

                    playAttempts++;
                    video
                        .play()
                        .then(() => {
                            hasStartedPlaying = true;
                            console.log(
                                `Autoplay success attempt ${playAttempts}`,
                            );

                            // Start continuous monitoring once playing
                            startPlaybackMonitor();
                        })
                        .catch(() => {
                            // Keep trying every 200ms
                            setTimeout(forcePlay, 200);
                        });
                };

                // Continuous playback monitoring - checks every 2 seconds
                const startPlaybackMonitor = () => {
                    if (playbackMonitor) return; // Already monitoring

                    playbackMonitor = setInterval(() => {
                        if (video.paused && !video.ended) {
                            console.log("Video paused detected - restarting");
                            video.play().catch(() => {
                                console.log("Manual play attempt failed");
                            });
                        }
                    }, 2000); // Check every 2 seconds
                };

                // Start forcing play immediately - let it play in background
                setTimeout(forcePlay, 50);
                setTimeout(forcePlay, 300);
                setTimeout(forcePlay, 600);

                // Unified expansion function - reveals video with opacity
                const performExpansion = () => {
                    // Make container visible but keep video hidden
                    container.style.display = "block";
                    container.style.opacity = "0";
                    container.style.maxHeight = "0";
                    container.style.overflow = "hidden";

                    // Animate expansion
                    setTimeout(() => {
                        container.style.transition =
                            "max-height 1.5s ease, opacity 1.2s ease 0.3s";
                        const containerWidth =
                            container.parentElement.offsetWidth;
                        const targetHeight = Math.min(
                            containerWidth * (9 / 16),
                            800,
                        );
                        container.style.maxHeight = targetHeight + "px";
                        container.style.opacity = "1";

                        setTimeout(() => {
                            container.style.maxHeight = "none";
                        }, 1500);
                    }, 50);
                };

                // Expand and ensure playing
                const expandAndPlay = () => {
                    performExpansion();

                    // Force another play attempt after expansion
                    forcePlay();

                    // Extra check after expansion
                    setTimeout(() => {
                        if (video.paused && !video.ended) {
                            console.log("Post-expansion play check");
                            video.play().catch(() => {});
                        }

                        // Start monitoring if not already started
                        if (!hasStartedPlaying) {
                            hasStartedPlaying = true;
                            startPlaybackMonitor();
                        }
                    }, 2000);
                };

                // Multiple event listeners - trigger expansion when ready
                let hasExpanded = false;

                video.addEventListener(
                    "loadedmetadata",
                    () => {
                        if (!hasExpanded) {
                            hasExpanded = true;
                            expandAndPlay();
                        }
                    },
                    { once: true },
                );

                video.addEventListener(
                    "loadeddata",
                    () => {
                        if (!hasExpanded) {
                            hasExpanded = true;
                            expandAndPlay();
                        }
                    },
                    { once: true },
                );

                video.addEventListener(
                    "canplay",
                    () => {
                        if (!hasExpanded) {
                            hasExpanded = true;
                            expandAndPlay();
                        }
                    },
                    { once: true },
                );

                // Fallback - expand after 1.5 seconds regardless
                setTimeout(() => {
                    if (!hasExpanded) {
                        hasExpanded = true;
                        expandAndPlay();
                    }
                }, 1500);
            }
        };

        // Defer loading by 2 seconds
        setTimeout(() => {
            loadShowreel();
        }, 2000);
    });
</script>

<style>
    :root {
        --sci-fi-cyan: #00f3ff;
        --sci-fi-glow: rgba(0, 243, 255, 0.2);
    }

    .showreel-container {
        width: 100%;
        max-width: var(--max-width);
        margin: 0 auto;
        margin-top: 0;
        margin-bottom: 0;

        position: relative;

        /* Will be animated from 0 to full height */
        /* Height will be set dynamically based on aspect ratio */

        background-color: #050a10;

        /* Sci-Fi Theme Styling */
        border-radius: 12px;
        border: 1px solid rgba(0, 243, 255, 0.3);
        box-shadow:
            0 10px 40px rgba(0, 0, 0, 0.6),
            0 0 20px var(--sci-fi-glow);

        /* Smooth transitions will be applied via JS */
    }

    /* Corner Accents (Pseudo-elements) */
    .showreel-container::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 12px;
        box-shadow: inset 0 0 20px rgba(0, 243, 255, 0.1);
        pointer-events: none;
        z-index: 2;
    }

    .showreel-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        aspect-ratio: 16 / 9;
    }

    /* Video Controls Container */
    .video-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 10;
        display: flex;
        gap: 12px;
    }

    /* Control Button Styling (Mute & Fullscreen) */
    .control-btn {
        background: rgba(5, 10, 16, 0.8);
        border: 1px solid var(--sci-fi-cyan);
        color: var(--sci-fi-cyan);
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        backdrop-filter: blur(4px);
    }

    .control-btn:hover {
        background: rgba(0, 243, 255, 0.1);
        box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
    }

    .control-btn svg {
        width: 20px;
        height: 20px;
        fill: currentColor;
    }

    /* Show buttons on container hover */
    .showreel-container:hover .control-btn {
        opacity: 1;
        transform: translateY(0);
    }

    /* Credits Section (Now separate from video container) */
    .showreel-credits {
        width: 100%;
        max-width: var(--max-width);
        margin: 0 auto;
        margin-top: 2rem;
        margin-bottom: var(--space-2xl);
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 0;
    }

    .credits-roles {
        font-family: var(--font-mono);
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-tertiary);
        margin: 0;
        line-height: 1.6;
    }

    .role-label {
        color: var(--text-secondary);
        font-weight: 600;
        margin-right: 0.5rem;
    }

    .view-all-btn {
        display: inline-block;
        width: fit-content;
        font-family: monospace;
        font-size: 0.9rem;
        color: var(--text-primary);
        background: transparent;
        border: 1px solid var(--border-subtle);
        padding: 0.75rem 1.5rem;
        border-radius: 2px;
        text-decoration: none;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .view-all-btn:hover {
        background: var(--text-primary);
        color: #000; /* Dark text for visibility */
        border-color: var(--text-primary);
    }

    @media (max-width: 768px) {
        .showreel-container {
            border-radius: 0;
            margin-left: -24px;
            width: calc(100% + 48px);
            max-width: none;
            border-left: none;
            border-right: none;
        }

        /* Always show control buttons on mobile since there is no hover */
        .control-btn {
            opacity: 1;
            transform: translateY(0);
        }

        .video-controls {
            bottom: 16px;
            right: 16px;
        }
    }
</style>
