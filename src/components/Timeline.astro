---
import { supabase } from "../lib/supabaseClient";

// Fetch data from Supabase
let timelineCards = [];
let error = null;

if (supabase) {
  const { data, error: err } = await supabase
    .from("about_timeline_cards")
    .select("*")
    .order("sort_index", { ascending: true }); // 0 = newest (2025)

  if (err) {
    console.error("Error fetching timeline cards:", err);
    error = err;
  } else {
    timelineCards = data;
  }
} else {
  console.warn("Supabase client not initialized");
}
---

<section class="timeline-section">
  {error && <p class="error-message">Unable to load timeline. Please try again later.</p>}
  
  {!error && timelineCards && timelineCards.length > 0 && (
    <div class="cards-wrapper">
        <div class="stack-base">
            {timelineCards.map((card, index) => (
                <div 
                    class="card-container" 
                    data-index={index}
                    style={`z-index: ${index + 1};`} 
                >
                    <div 
                      class={`timeline-card ${card.highlight ? 'highlight' : ''}`}
                      style={`
                        --gradient-start: ${card.gradient_g1 || '#f0f0f0'};
                        --gradient-end: ${card.gradient_g2 || '#e0e0e0'};
                      `}
                    >
                      <div class="card-grid">
                        <!-- Top Left: Header + Meta -->
                        <div class="grid-cell top-left">
                            <span class="year">
                                {card.year} 
                                <span class="year-suffix">
                                    {(card.half === 'H1' ? '(first half)' : card.half === 'H2' ? '(second half)' : `(${card.half})`)}
                                </span>
                            </span>
                            <span class="focus-text">{card.focus}</span>
                            
                            <!-- Metadata moved here -->
                            <div class="header-meta">
                               {card.location_context && <div class="meta-item"><span class="icon">üìç</span> {card.location_context}</div>}
                               {card.institutions && <div class="meta-item"><span class="icon">üèõÔ∏è</span> {card.institutions}</div>}
                            </div>
                        </div>

                        <!-- Top Right: Value & Keywords -->
                        <div class="grid-cell top-right">
                             <div class="value-block">
                                <span class="label">Value delivered</span>
                                <p class="value-text">{card.value_built}</p>
                             </div>
                             {card.brands_projects && (
                                 <div class="keywords-row">
                                     {card.brands_projects.split(',').slice(0,4).map((k: string) => (
                                         <span class="keyword">{k.trim()}</span>
                                     ))}
                                 </div>
                             )}
                        </div>

                        <!-- Bottom: Detailed Description (Full Width) -->
                        <div class="grid-cell bottom-full">
                           <p class="description">{card.what_happened}</p>
                        </div>
                      </div>
                    </div>
                </div>
            ))}
        </div>
    </div>
  )}
</section>

<script>
    import { gsap } from "gsap";
    import { ScrollTrigger } from "gsap/ScrollTrigger";

    gsap.registerPlugin(ScrollTrigger);

    document.addEventListener('DOMContentLoaded', () => {
        const wrapper = document.querySelector('.cards-wrapper') as HTMLElement;
        const stackBase = document.querySelector('.stack-base') as HTMLElement;
        const cards = gsap.utils.toArray('.card-container') as HTMLElement[];

        if (!wrapper || !stackBase || cards.length === 0) return;

        // Configuration
        const headerHeight = 120; 
        
        // Counter-Drift Logic
        const totalDrift = (cards.length - 1) * headerHeight;
       
        const tl = gsap.timeline({
            scrollTrigger: {
                trigger: ".timeline-section",
                pin: true,
                start: "top top",
                end: `+=${cards.length * 200}%`, // Significantly increased scroll distance
                scrub: 0.1, // Instant control
                snap: {
                   snapTo: 1 / (cards.length - 1),
                   duration: {min: 0.1, max: 0.2}, 
                   delay: 0,
                   ease: "power1.out"
                }, 
                invalidateOnRefresh: true
            }
        });

        // 1. Stack Drift
        tl.to(stackBase, {
            y: -totalDrift, 
            ease: "none",
            duration: cards.length 
        }, 0);

        // 2. Card Animation
        cards.forEach((cardElement, i) => {
            if (i === 0) return; 
            const card = cardElement as HTMLElement;
            const stopPosition = i * headerHeight; 
            
            // "Fly in from deep bottom"
            tl.fromTo(card, 
                { 
                    yPercent: 600, 
                    scale: 0.9,
                }, 
                { 
                    yPercent: 0, 
                    y: stopPosition, 
                    scale: 1,
                    ease: "power2.out", 
                    duration: 1
                }, 
                i - 1 
            );
        });
    });
</script>

<style>
  .timeline-section {
    position: relative;
    width: 100%;
    max-width: 820px; /* Widened from 720px */
    height: 100vh; 
    overflow: visible; 
  }

  .cards-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: flex-start;
    align-items: flex-start;
    padding-top: 30vh; 
  }
  
  .stack-base {
      position: relative;
      width: 100%;
      height: 100%;
      will-change: transform;
  }

  .card-container {
    position: absolute;
    top: 0; 
    left: 0;
    width: 100%;
    display: flex;
    justify-content: flex-start; 
    will-change: transform;
  }
  
  .timeline-card {
    width: 100%;
    height: auto; /* HTML content dictates height */
    min-height: 220px;
    /* Removed max-height constraint to allow full content display */
    
    background-color: #f8f8f8; 
    background-image: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    
    border-radius: 16px; 
    padding: 2.5rem; 
    padding-right: 3.5rem; /* Reduced from 5rem as requested, still generous */
    padding-bottom: 3rem; /* Fixed spacing from end of content */
    
    box-shadow: 0 -8px 25px rgba(0,0,0,0.04);
    color: #1a1a1a;
    border: 1px solid rgba(255,255,255,0.6);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  
  .card-grid {
      display: grid;
      grid-template-columns: 1fr 1fr; /* Exact 50/50 Split */
      grid-template-rows: auto 1fr;
      gap: 2rem; 
      height: 100%;
      width: 100%;
  }
  
  /* Top Left: Header + Meta */
  .top-left {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      border-right: 1px solid rgba(0,0,0,0.05); 
      padding-right: 2rem; /* Increased gutter */
      min-width: 0; 
  }
  
  .year {
      font-size: 2rem; 
      font-weight: 700; 
      line-height: 1;
      letter-spacing: -0.02em;
      margin-bottom: 0.25rem;
      color: #000;
  }
  
  .year-suffix {
      font-size: 0.5em; 
      font-weight: 300; 
      opacity: 0.6;
      margin-left: 0.3rem;
      vertical-align: middle;
  }
  
  .focus-text {
      font-size: 1rem; 
      font-weight: 500; 
      opacity: 0.7;
      margin-bottom: 0; 
  }
  
  .header-meta {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      margin-top: 1.5rem; 
  }
  
  /* Top Right: Value */
  .top-right {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      padding-left: 1rem;
      min-width: 0;
  }
  
  .value-block .label {
      font-size: 0.65rem;
      opacity: 0.5;
      /* Removed text-transform: uppercase */
  }
  
  .value-text {
      font-size: 0.95rem; 
      font-weight: 500; 
      line-height: 1.3;
      margin-top: 0.2rem;
      white-space: normal; /* Allow wrapping */
      word-break: break-word; /* Prevent overflow of long words */
  }
  
  .keywords-row {
      margin-top: 0.75rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
  }
  
  .keyword {
      font-size: 0.65rem;
      background: rgba(255,255,255,0.5);
      padding: 0.15rem 0.4rem;
      border-radius: 6px;
      font-weight: 400;
      white-space: nowrap; /* Keep individual keywords together */
  }

  /* Bottom: Description (Full Width) */
  .bottom-full {
      grid-column: 1 / -1; 
      padding-top: 1.25rem;
      border-top: 1px solid rgba(0,0,0,0.05); 
      display: flex;
      align-items: flex-start;
  }
  
  .description {
      font-size: 0.95rem;
      line-height: 1.5;
      font-weight: 400; 
      opacity: 0.85;
      max-width: 95%; 
  }

  .meta-item {
      font-size: 0.75rem;
      opacity: 0.65;
      display: flex;
      align-items: center;
      gap: 0.4rem;
  }
  .icon { opacity: 0.6; }

  /* Responsive */
  @media (max-width: 768px) {
      .cards-wrapper {
          padding-top: 20vh;
      }
      .card-grid {
          display: flex;
          flex-direction: column;
          gap: 1rem;
      }
      .top-left {
          border-right: none;
          padding-right: 0;
          padding-bottom: 1rem;
          border-bottom: 1px solid rgba(0,0,0,0.05);
      }
      .top-right {
          padding-left: 0; /* Remove indentation on mobile for alignment */
      }
      .timeline-card {
          height: auto;
          min-height: auto;
          padding: 1.5rem;
          max-height: 80vh; 
      }
      .bottom-full {
          border-top: none;
          padding-top: 0;
      }
      .value-text {
          white-space: normal; /* Allow wrapping on mobile if constrained */
      }
  }
</style>
