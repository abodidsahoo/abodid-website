---
import "../styles/global.css";
import "../styles/brands.css";
import Header from "../components/Header";
import Footer from "../components/Footer.astro";
import SEO from "../components/SEO.astro";
import StickyMobileNav from "../components/StickyMobileNav.jsx";
import NewsletterPopup from "../components/NewsletterPopup.jsx";
import { getPageMetadata } from "../lib/api";

const {
  title,
  description,
  image,
  type,
  hideHeader = false,
  fullWidth = false,
} = Astro.props;

// Fetch metadata from database if not provided via props
const pagePath = Astro.url.pathname;
const dbMetadata = await getPageMetadata(pagePath);

// Props override database values
const finalTitle = title || dbMetadata?.meta_title || dbMetadata?.page_title;
const finalDescription = description || dbMetadata?.meta_description;
const finalImage = image || dbMetadata?.og_image_url;
const finalType = type || dbMetadata?.og_type || "website";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Abodid Blog"
      href="/rss.xml"
    />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <SEO
      title={finalTitle}
      description={finalDescription}
      image={finalImage}
      type={finalType}
    />
    <!-- Dynamic SEO & Social Images applied -->

    <!-- Theme Initialization to prevent FOUC - ALWAYS DARK MODE -->
    <script is:inline>
      // Force dark mode site-wide - ignore light mode preferences
      // Only exception is reader-mode on blog posts (handled separately)
      const theme = "dark";

      document.documentElement.setAttribute("data-theme", "dark");

      // Clear any old light mode preferences
      if (typeof localStorage !== "undefined") {
        const oldTheme = localStorage.getItem("theme");
        if (oldTheme === "light") {
          localStorage.removeItem("theme");
        }
      }
    </script>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <!-- <Header /> -->
    <!-- Header: client:load for immediate hydration priority -->
    {!hideHeader && <Header client:load />}
    <div class="global-grid-bg"></div>
    <div class="global-glow-bg"></div>
    <main
      id="main-content"
      class={`${fullWidth ? "page-content-full" : "container page-content"}`}
    >
      <slot />
    </main>
    <StickyMobileNav client:idle />
    <NewsletterPopup client:only="react" />
    <Footer />
  </body>
</html>

<style>
  .page-content {
    padding-top: 110px; /* 80px header + 30px spacing */
    padding-bottom: 3rem;
    position: relative;
    z-index: 1; /* Ensure content is above grid */
  }

  .page-content-full {
    padding: 0;
    width: 100vw;
    position: relative;
    z-index: 1;
  }

  .global-grid-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0; /* Behind content but check base layout stacking */
    pointer-events: none;

    /* Subtle Grid Background */
    background-image:
      linear-gradient(to right, var(--grid-color-2) 1px, transparent 1px),
      linear-gradient(to bottom, var(--grid-color-2) 1px, transparent 1px);
    background-size: 60px 60px; /* PERFECT SQUARE as requested */
    background-position: center top;

    /* Soft fade on edges */
    -webkit-mask-image: radial-gradient(
      ellipse at center,
      black 30%,
      transparent 80%
    );
    mask-image: radial-gradient(ellipse at center, black 30%, transparent 80%);
  }

  /* Ensure Footer is above grid */
  :global(.site-footer) {
    position: relative;
    z-index: 10;
    background-color: var(--bg-surface);
  }

  .global-glow-bg {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0; /* Same layer as grid, interactions managed by opacity */
    pointer-events: none;
    opacity: var(--glow-intensity, 1);
    transition: opacity 0.3s ease-out;

    /* Brighter Grid for Glow - Reduced power */
    background-image:
      linear-gradient(to right, var(--grid-color-1) 1px, transparent 1px),
      linear-gradient(to bottom, var(--grid-color-1) 1px, transparent 1px);
    background-size: 60px 60px; /* PERFECT SQUARE */
    background-position: center top;

    /* Reveal only near mouse AND faded at edges (Global Mask) */
    -webkit-mask-image:
      radial-gradient(
        circle 300px at var(--mouse-x, -500px) var(--mouse-y, -500px),
        black,
        transparent
      ),
      radial-gradient(ellipse at center, black 30%, transparent 80%);
    mask-image:
      radial-gradient(
        circle 300px at var(--mouse-x, -500px) var(--mouse-y, -500px),
        black,
        transparent
      ),
      radial-gradient(ellipse at center, black 30%, transparent 80%);

    /* Composite: Intersect them so glow fades at edges */
    -webkit-mask-composite: source-in;
    mask-composite: intersect;
  }

  .skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: #000;
    color: #fff;
    padding: 8px;
    z-index: 9999;
    transition: top 0.2s;
  }

  .skip-link:focus {
    top: 0;
  }
</style>

<script>
  function initGlobalEffects() {
    const glowBg = document.querySelector(".global-glow-bg") as HTMLElement;
    if (!glowBg) return;

    // Mouse Tracking
    window.addEventListener(
      "mousemove",
      (e) => {
        glowBg.style.setProperty("--mouse-x", `${e.clientX}px`);
        glowBg.style.setProperty("--mouse-y", `${e.clientY}px`);
      },
      { passive: true },
    );

    // Scroll Intensity Tracking
    const updateIntensity = () => {
      // Check if we are on the homepage or the experiment page
      const isHome =
        window.location.pathname === "/" ||
        window.location.pathname === "" ||
        window.location.pathname === "/test-landing";

      if (!isHome) {
        // "Very subtle glow if it at all happens" on other pages
        glowBg.style.setProperty("--glow-intensity", "0.05");
        return;
      }

      // Homepage Logic: Targeted for typewriter area (top)
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;

      // Faster fade out to ensure it's mainly for the top area
      const fadeDistance = windowHeight * 1.0;
      const minIntensity = 0.05; // "Hardly visible"

      let intensity = 1 - scrollY / fadeDistance;
      if (intensity < minIntensity) intensity = minIntensity;

      glowBg.style.setProperty("--glow-intensity", intensity.toString());
    };

    window.addEventListener("scroll", updateIntensity, { passive: true });
    updateIntensity(); // Initial call
  }

  // Init
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initGlobalEffects);
  } else {
    initGlobalEffects();
  }
</script>
